{"version":3,"file":"contenttree.min.js","sources":["../../../src/local/courseeditor/contenttree.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Course index keyboard navigation and aria-tree compatibility.\n *\n * Node tree and bootstrap collapsibles don't use the same HTML structure. However,\n * all keybindings and logic is compatible. This class translate the primitive opetations\n * to a bootstrap collapsible structure.\n *\n * @module     core_courseformat/local/courseindex/keyboardnav\n * @class      core_courseformat/local/courseindex/keyboardnav\n * @copyright  2021 Ferran Recio <ferran@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// The core/tree uses jQuery to expand all nodes.\nimport jQuery from 'jquery';\nimport Tree from 'core/tree';\nimport {getList} from 'core/normalise';\n\nexport default class extends Tree {\n\n    /**\n     * Setup the core/tree keyboard navigation.\n     *\n     * @param {Element|undefined} mainElement an alternative main element in case it is not from the parent component\n     * @param {Object|undefined} selectors alternative selectors\n     * @param {boolean} preventcache if the elements cache must be disabled.\n     */\n    constructor(mainElement, selectors, preventcache) {\n        // Init this value with the parent DOM element.\n        super(mainElement);\n\n        // Get selectors from parent.\n        this.selectors = {\n            SECTION: selectors.SECTION,\n            TOGGLER: selectors.TOGGLER,\n            COLLAPSE: selectors.COLLAPSE,\n            ENTER: selectors.ENTER ?? selectors.TOGGLER,\n        };\n\n        // The core/tree library saves the visible elements cache inside the main tree node.\n        // However, in edit mode content can change suddenly so we need to refresh caches when needed.\n        if (preventcache) {\n            this._getVisibleItems = this.getVisibleItems;\n            this.getVisibleItems = () => {\n                this.refreshVisibleItemsCache();\n                return this._getVisibleItems();\n            };\n        }\n        // All jQuery events can be replaced when MDL-71979 is integrated.\n        this.treeRoot.on('hidden.bs.collapse shown.bs.collapse', () => {\n            this.refreshVisibleItemsCache();\n        });\n        // Register a custom callback for pressing enter key.\n        this.registerEnterCallback(this.enterCallback.bind(this));\n    }\n\n    /**\n     * Return the current active node.\n     *\n     * @return {Element|undefined} the active item if any\n     */\n    getActiveItem() {\n        const activeItem = this.treeRoot.data('activeItem');\n        if (activeItem) {\n            return getList(activeItem)[0];\n        }\n        return undefined;\n    }\n\n    /**\n     * Handle enter key on a collpasible node.\n     *\n     * @param {JQuery} jQueryItem the jQuery object\n     */\n    enterCallback(jQueryItem) {\n        const item = getList(jQueryItem)[0];\n        if (this.isGroupItem(jQueryItem)) {\n            // Group elements is like clicking a topic but without loosing the focus.\n            const enter = item.querySelector(this.selectors.ENTER);\n            if (enter.getAttribute('href') !== '#') {\n                window.location.href = enter.getAttribute('href');\n            }\n            enter.click();\n        } else {\n            // Activity links just follow the link href.\n            const link = item.querySelector('a');\n            if (link.getAttribute('href') !== '#') {\n                window.location.href = link.getAttribute('href');\n            } else {\n                link.click();\n            }\n            return;\n        }\n    }\n\n    /**\n     * Handle an item click.\n     *\n     * @param {Event} event the click event\n     * @param {jQuery} jQueryItem the item clicked\n     */\n    handleItemClick(event, jQueryItem) {\n        const isChevron = event.target.closest(this.selectors.COLLAPSE);\n        // Only chevron clicks toogle the sections always.\n        if (isChevron) {\n            super.handleItemClick(event, jQueryItem);\n            return;\n        }\n        // This is a title or activity name click.\n        jQueryItem.focus();\n        if (this.isGroupItem(jQueryItem)) {\n            this.expandGroup(jQueryItem);\n        }\n    }\n\n    /**\n     * Check if a gorup item is collapsed.\n     *\n     * @param {JQuery} jQueryItem  the jQuery object\n     * @returns {boolean} if the element is collapsed\n     */\n    isGroupCollapsed(jQueryItem) {\n        const item = getList(jQueryItem)[0];\n        const toggler = item.querySelector(`[aria-expanded]`);\n        return toggler.getAttribute('aria-expanded') === 'false';\n    }\n\n    /**\n     * Toggle a group item.\n     *\n     * @param {JQuery} item  the jQuery object\n     */\n    toggleGroup(item) {\n        // All jQuery in this segment of code can be replaced when MDL-71979 is integrated.\n        const toggler = item.find(this.selectors.COLLAPSE);\n        let collapsibleId = toggler.data('target') ?? toggler.attr('href');\n        if (!collapsibleId) {\n            return;\n        }\n        collapsibleId = collapsibleId.replace('#', '');\n\n        // Bootstrap 4 uses jQuery to interact with collapsibles.\n        const collapsible = jQuery(`#${collapsibleId}`);\n        if (collapsible.length) {\n            jQuery(`#${collapsibleId}`).collapse('toggle');\n        }\n    }\n\n    /**\n     * Expand a group item.\n     *\n     * @param {JQuery} item  the jQuery object\n     */\n    expandGroup(item) {\n        if (this.isGroupCollapsed(item)) {\n            this.toggleGroup(item);\n        }\n    }\n\n    /**\n     * Collpase a group item.\n     *\n     * @param {JQuery} item  the jQuery object\n     */\n    collapseGroup(item) {\n        if (!this.isGroupCollapsed(item)) {\n            this.toggleGroup(item);\n        }\n    }\n\n    /**\n     * Expand all groups.\n     */\n    expandAllGroups() {\n        const togglers = getList(this.treeRoot)[0].querySelectorAll(this.selectors.SECTION);\n        togglers.forEach(item => {\n            this.expandGroup(jQuery(item));\n        });\n    }\n}\n"],"names":["_interopRequireDefault","obj","__esModule","default","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","arg","key","input","hint","_typeof","prim","Symbol","toPrimitive","undefined","res","call","TypeError","String","Number","_toPrimitive","_get","Reflect","get","bind","property","receiver","base","_superPropBase","desc","getOwnPropertyDescriptor","arguments","value","apply","this","object","prototype","hasOwnProperty","_getPrototypeOf","_setPrototypeOf","o","p","setPrototypeOf","__proto__","_createSuper","Derived","hasNativeReflectConstruct","construct","sham","Proxy","Boolean","valueOf","e","_isNativeReflectConstruct","result","Super","NewTarget","constructor","_possibleConstructorReturn","self","_assertThisInitialized","ReferenceError","getPrototypeOf","_jquery","_default","_Tree","subClass","superClass","create","_inherits","Constructor","protoProps","staticProps","_super","mainElement","selectors","preventcache","_selectors$ENTER","_this","instance","_classCallCheck","SECTION","TOGGLER","COLLAPSE","ENTER","_getVisibleItems","getVisibleItems","refreshVisibleItemsCache","treeRoot","on","registerEnterCallback","enterCallback","activeItem","data","getList","jQueryItem","item","isGroupItem","enter","querySelector","getAttribute","window","location","href","click","link","event","closest","focus","expandGroup","_toggler$data","toggler","find","collapsibleId","attr","replace","jQuery","concat","collapse","isGroupCollapsed","toggleGroup","_this2","querySelectorAll","forEach","_tree","_exports"],"mappings":"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"}