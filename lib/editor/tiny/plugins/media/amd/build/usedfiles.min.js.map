{"version":3,"file":"usedfiles.min.js","sources":["../src/usedfiles.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Media Manager usedfiles.\n *\n * @module      tiny_media/usedfiles\n * @copyright   2022, Stevani Andolo <stevani@hotmail.com.au>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Templates from 'core/templates';\nimport Config from 'core/config';\n\nclass UsedFileManager {\n    constructor(files, userContext, itemId, elementId) {\n        this.files = files;\n        this.userContext = userContext;\n        this.itemId = itemId;\n        this.elementId = elementId;\n    }\n\n    getElementId() {\n        return this.elementId;\n    }\n\n    getUsedFiles() {\n        const editor = window.parent.tinymce.EditorManager.get(this.getElementId());\n        if (!editor) {\n            window.console.error(`Editor not found for ${this.getElementId()}`);\n            return [];\n        }\n        const content = editor.getContent();\n        const baseUrl = `${Config.wwwroot}/draftfile.php/${this.userContext}/user/draft/${this.itemId}/`;\n        const pattern = new RegExp(\"[\\\"']\" + baseUrl.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&') + \"(?<filename>.+?)[\\\\?\\\"']\", 'gm');\n\n        const usedFiles = [...content.matchAll(pattern)].map((match) => decodeURIComponent(match.groups.filename));\n\n        return usedFiles;\n    }\n\n    // Return an array of unused files.\n    findUnusedFiles(usedFiles) {\n        return Object.entries(this.files)\n            .filter(([filename]) => !usedFiles.includes(filename))\n            .map(([filename]) => filename);\n    }\n\n    // Return an array of missing files.\n    findMissingFiles(usedFiles) {\n        return usedFiles.filter((filename) => !this.files.hasOwnProperty(filename));\n    }\n\n    updateFiles() {\n        const form = document.querySelector('form');\n        const usedFiles = this.getUsedFiles();\n        const unusedFiles = this.findUnusedFiles(usedFiles);\n        const missingFiles = this.findMissingFiles(usedFiles);\n\n        form.querySelectorAll('input[type=checkbox][name^=\"deletefile\"]').forEach((checkbox) => {\n            if (!unusedFiles.includes(checkbox.dataset.filename)) {\n                checkbox.closest('.fitem').remove();\n            }\n        });\n\n        form.classList.toggle('has-missing-files', !!missingFiles.length);\n        form.classList.toggle('has-unused-files', !!unusedFiles.length);\n\n        return Templates.renderForPromise('tiny_media/missingfiles', {\n            missingFiles,\n        }).then(({html, js}) => {\n            Templates.replaceNodeContents(form.querySelector('.missing-files'), html, js);\n            return;\n        });\n    }\n}\n\nexport const init = (files, usercontext, itemid, elementid) => {\n    const manager = new UsedFileManager(files, usercontext, itemid, elementid);\n    manager.updateFiles();\n\n    return manager;\n};\n"],"names":["obj","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_typeof","Symbol","iterator","constructor","prototype","_slicedToArray","arr","i","Array","isArray","_arrayWithHoles","_i","_s","_e","_x","_r","_arr","_n","_d","call","next","Object","done","push","value","length","err","return","_iterableToArrayLimit","_unsupportedIterableToArray","TypeError","_nonIterableRest","_toConsumableArray","_arrayLikeToArray","_arrayWithoutHoles","iter","from","_iterableToArray","_nonIterableSpread","o","minLen","n","toString","slice","name","test","len","arr2","_defineProperties","target","props","descriptor","enumerable","configurable","writable","defineProperty","arg","key","input","hint","prim","toPrimitive","undefined","res","String","Number","_toPrimitive","Templates","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","getOwnPropertyDescriptor","hasOwnProperty","desc","set","_interopRequireWildcard","_config","UsedFileManager","files","userContext","itemId","elementId","instance","Constructor","_classCallCheck","this","protoProps","staticProps","editor","window","parent","tinymce","EditorManager","getElementId","console","error","content","getContent","baseUrl","concat","Config","wwwroot","pattern","RegExp","replace","matchAll","map","match","decodeURIComponent","groups","filename","usedFiles","entries","filter","_ref","includes","_ref3","_this","form","document","querySelector","getUsedFiles","unusedFiles","findUnusedFiles","missingFiles","findMissingFiles","querySelectorAll","forEach","checkbox","dataset","closest","remove","classList","toggle","renderForPromise","then","_ref5","html","js","replaceNodeContents","_exports","init","usercontext","itemid","elementid","manager","updateFiles"],"mappings":"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"}