{"version":3,"file":"initials.min.js","sources":["../../src/searchwidget/initials.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A small dropdown to filter users within the gradebook.\n *\n * @module    core_grades/searchwidget/initials\n * @copyright 2022 Mathew May <mathew.solutions>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Pending from 'core/pending';\nimport * as Url from 'core/url';\nimport CustomEvents from \"core/custom_interaction_events\";\nimport $ from 'jquery';\n\n/**\n * Whether the event listener has already been registered for this module.\n *\n * @type {boolean}\n */\nlet registered = false;\n\n// Contain our selectors within this file until they could be of use elsewhere.\nconst selectors = {\n    pageListItem: 'page-item',\n    pageClickableItem: '.page-link',\n    activeItem: 'active',\n    formDropdown: '.initialsdropdownform',\n    parentDomNode: '.initials-selector',\n    firstInitial: 'firstinitial',\n    lastInitial: 'lastinitial',\n    initialBars: '.initialbar', // Both first and last name use this class.\n    targetButton: 'initialswidget',\n    formItems: {\n        type: 'submit',\n        save: 'save',\n        cancel: 'cancel'\n    }\n};\n\n/**\n * Our initial hook into the module which will eventually allow us to handle the dropdown initials bar form.\n *\n * @param {String} callingLink The link to redirect upon form submission.\n */\nexport const init = (callingLink) => {\n    if (registered) {\n        return;\n    }\n    const pendingPromise = new Pending();\n    registerListenerEvents(callingLink);\n    // BS events always bubble so, we need to listen for the event higher up the chain.\n    $(selectors.parentDomNode).on('shown.bs.dropdown', () => {\n        document.querySelector(selectors.pageClickableItem).focus({preventScroll: true});\n    });\n    pendingPromise.resolve();\n    registered = true;\n};\n\n/**\n * Register event listeners.\n *\n * @param {String} callingLink The link to redirect upon form submission.\n */\nconst registerListenerEvents = (callingLink) => {\n    const events = [\n        'click',\n        CustomEvents.events.activate,\n        CustomEvents.events.keyboardActivate\n    ];\n    CustomEvents.define(document, events);\n\n    // Register events.\n    events.forEach((event) => {\n        document.addEventListener(event, (e) => {\n            // Always fetch the latest information when we click as state is a fickle thing.\n            let {firstActive, lastActive, sifirst, silast} = onClickVariables();\n            let itemToReset = '';\n\n            // Prevent the usual form behaviour.\n            if (e.target.closest(selectors.formDropdown)) {\n                e.preventDefault();\n            }\n\n            // Handle the state of active initials before form submission.\n            if (e.target.closest(`${selectors.formDropdown} .${selectors.pageListItem}`)) {\n                // Ensure the li items don't cause weird clicking emptying out the form.\n                if (e.target.classList.contains(selectors.pageListItem)) {\n                    return;\n                }\n\n                const initialsBar = e.target.closest(selectors.initialBars); // Find out which initial bar we are in.\n\n                // We want to find the current active item in the menu area the user selected.\n                // We also want to fetch the raw item out of the array for instant manipulation.\n                if (initialsBar.classList.contains(selectors.firstInitial)) {\n                    sifirst = e.target;\n                    itemToReset = firstActive;\n                } else {\n                    silast = e.target;\n                    itemToReset = lastActive;\n                }\n                swapActiveItems(itemToReset, e);\n            }\n\n            // Handle form submissions.\n            if (e.target.type === selectors.formItems.type) {\n                if (e.target.dataset.action === selectors.formItems.save) {\n                    // Ensure we strip out the value (All) as it messes with the PHP side of the initials bar.\n                    // Then we will redirect the user back onto the page with new filters applied.\n                    window.location = Url.relativeUrl(callingLink, {\n                        'id': e.target.closest(selectors.formDropdown).dataset.courseid,\n                        'sifirst': sifirst.parentElement.classList.contains('initialbarall') ? '' : sifirst.value,\n                        'silast': silast.parentElement.classList.contains('initialbarall') ? '' : silast.value,\n                    });\n                }\n                if (e.target.dataset.action === selectors.formItems.cancel) {\n                    $(`.${selectors.targetButton}`).dropdown('toggle');\n                }\n            }\n        });\n    });\n};\n\n/**\n * A small abstracted helper function which allows us to ensure we have up-to-date lists of nodes.\n *\n * @returns {{firstActive: HTMLElement, lastActive: HTMLElement, sifirst: ?String, silast: ?String}}\n */\nconst onClickVariables = () => {\n    // Ensure we have an up-to-date initials bar.\n    const firstItems = [...document.querySelectorAll(`.${selectors.firstInitial} li`)];\n    const lastItems = [...document.querySelectorAll(`.${selectors.lastInitial} li`)];\n    const firstActive = firstItems.filter((item) => item.classList.contains(selectors.activeItem))[0];\n    const lastActive = lastItems.filter((item) => item.classList.contains(selectors.activeItem))[0];\n    // Ensure we retain both of the selections from a previous instance.\n    let sifirst = firstActive.querySelector(selectors.pageClickableItem);\n    let silast = lastActive.querySelector(selectors.pageClickableItem);\n    return {firstActive, lastActive, sifirst, silast};\n};\n\n/**\n * Given we are provided the old li and current click event, swap around the active properties.\n *\n * @param {HTMLElement} itemToReset\n * @param {Event} e\n */\nconst swapActiveItems = (itemToReset, e) => {\n    itemToReset.classList.remove(selectors.activeItem);\n    itemToReset.querySelector(selectors.pageClickableItem).ariaCurrent = false;\n\n    // Set the select item as the current item.\n    const itemToSetActive = e.target.parentElement;\n    itemToSetActive.classList.add(selectors.activeItem);\n    e.target.ariaCurrent = true;\n};\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireDefault","obj","__esModule","default","_toConsumableArray","arr","Array","isArray","_arrayLikeToArray","_arrayWithoutHoles","iter","Symbol","iterator","from","_iterableToArray","o","minLen","n","Object","prototype","toString","call","slice","constructor","name","test","_unsupportedIterableToArray","TypeError","_nonIterableSpread","len","length","i","arr2","_pending","Url","_typeof","cache","has","get","newObj","hasPropertyDescriptor","defineProperty","getOwnPropertyDescriptor","key","hasOwnProperty","desc","set","_interopRequireWildcard","_custom_interaction_events","_jquery","registered","selectors","type","save","cancel","_exports","init","callingLink","pendingPromise","Pending","registerListenerEvents","$","on","document","querySelector","focus","preventScroll","resolve","events","CustomEvents","activate","keyboardActivate","define","forEach","event","addEventListener","e","_onClickVariables","onClickVariables","firstActive","lastActive","sifirst","silast","itemToReset","target","closest","preventDefault","classList","contains","swapActiveItems","dataset","action","window","location","relativeUrl","id","courseid","parentElement","value","dropdown","firstItems","querySelectorAll","lastItems","filter","item","remove","ariaCurrent","add"],"mappings":"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"}