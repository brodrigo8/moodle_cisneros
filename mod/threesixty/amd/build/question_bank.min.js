define(["jquery","core/templates","core/notification","core/ajax","core/str","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g){function h(a){var b=[];"undefined"==typeof a&&(a=!1);for(var c in q){var d={typeVal:c,typeName:q[c]};a!==!1&&c==a&&(d.selected=!0),b.push(d)}return b}function i(){var e=d.call([{methodname:"mod_threesixty_get_questions",args:{}}]);e[0].done(function(d){t=d.questions;var e={pickerMode:p,questions:k(t)};b.render("mod_threesixty/question_list",e).done(function(b){a("#questionListWrapper").html(b),v()}).fail(c.exception)}).fail(c.exception)}function j(b,h){s?(s.setBody(h),s.show()):f.create({type:f.types.SAVE_CANCEL,title:b,body:h,large:!0}).done(function(b){s=b,s.show(),b.getRoot().on(g.shown,function(){a("#question-input").focus()}),b.getRoot().on(g.hidden,function(){b.setBody("")}),b.getRoot().on(g.save,function(){var b=a("#question-input").val().trim();if(!b)return void e.get_string("requiredelement","form").done(function(b){var c=a("<div/>").append(b).attr("class","alert alert-error").attr("role","alert");a(".error-container").html(c)}).fail(c.exception);var f=a("#question-type-select").val(),g={question:b,type:f},h="mod_threesixty_add_question",j=a("#question-id").val();j&&(h="mod_threesixty_update_question",g.id=j);var k=d.call([{methodname:h,args:g}]);k[0].done(function(){i()}).fail(c.exception)})})}function k(a){for(var b in a){var c=a[b];o.indexOf(a[b].id)!==-1&&(c.checked=!0)}return a}function l(b,e){r?(r.setBody(e),r.show()):f.create({type:f.types.SAVE_CANCEL,title:b,body:e,large:!0}).done(function(b){var e=b.getRoot();e.on(g.hidden,function(){b.setBody("")}),e.on(g.save,function(){var b=!1;if(a.each(n,function(a,c){o.indexOf(c)==-1&&(b=!0)}),b||a.each(o,function(a,c){n.indexOf(c)==-1&&(b=!0)}),b){var e={threesixtyid:p,questionids:o},f=d.call([{methodname:"mod_threesixty_set_items",args:e}]);f[0].done(function(){require(["mod_threesixty/edit_items"],function(a){a.refreshItemList()})}).fail(c.exception)}}),r=b,r.show()})}function m(){var a={pickerMode:p},f=d.call([{methodname:"mod_threesixty_get_questions",args:{}}]);f[0].done(function(d){t=d.questions,a.questions=k(t);var f=b.render("mod_threesixty/question_bank",a);e.get_string("labelpickfromquestionbank","mod_threesixty").done(function(a){l(a,f)}).fail(c.exception)}).fail(c.exception)}var n,o,p,q,r,s,t=[],u=function(a){e.get_string("addanewquestion","mod_threesixty").done(function(c){var d={};if("undefined"!=typeof a){d.questionid=a;for(var e in t){var f=t[e];if(f.id==a){d.question=f.question,d.type=f.type;break}}}d.questionTypes=h(d.type);var g=b.render("mod_threesixty/item_edit",d);j(c,g)}).fail(c.exception)},v=function(){a(".question-checkbox").click(function(){var b=parseInt(this.getAttribute("data-questionid"));if(a(this).is(":checked"))o.push(b);else{var c=o.indexOf(b);c>-1&&o.splice(c,1)}}),a(".edit-question-button").click(function(){var b=a(this).data("questionid");u(b)}),a(".delete-question-button").click(function(){var a=this;e.get_string("deletequestion","mod_threesixty").done(function(b){f.create({title:b,body:e.get_string("confirmquestiondeletion","mod_threesixty"),type:f.types.CONFIRM}).done(function(b){b.getRoot().on(g.yes,function(){var b=a.getAttribute("data-questionid"),e=d.call([{methodname:"mod_threesixty_delete_question",args:{id:b}}]);e[0].done(function(){i()}).fail(c.exception)}),b.show()})})})},w=function(a){p=a;var b=[{methodname:"mod_threesixty_get_question_types",args:{}}];p&&b.push({methodname:"mod_threesixty_get_items",args:{threesixtyid:p}});var e=d.call(b);e[0].done(function(a){q=a.questiontypes,p?(o=[],n=[],e[1].done(function(a){var b=a.items;for(var c in b)o.push(b[c].questionid),n.push(b[c].questionid);m()}).fail(c.exception)):m()}).fail(c.exception)},x={init:w,displayInputDialogue:u,bindItemActionEvents:v};return x});