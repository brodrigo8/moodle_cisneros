{"version":3,"file":"form.min.js","sources":["../src/form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Custom Field interaction management for Moodle.\n *\n * @module     core_customfield/form\n * @copyright  2018 Toni Barbera\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport 'core/inplace_editable';\nimport {call as fetchMany} from 'core/ajax';\nimport {\n    get_string as getString,\n    get_strings as getStrings,\n} from 'core/str';\nimport ModalForm from 'core_form/modalform';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport SortableList from 'core/sortable_list';\nimport Templates from 'core/templates';\nimport jQuery from 'jquery';\n\n/**\n * Display confirmation dialogue\n *\n * @param {Number} id\n * @param {String} type\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst confirmDelete = (id, type, component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:confirmDelete');\n\n    getStrings([\n        {'key': 'confirm'},\n        {'key': 'confirmdelete' + type, component: 'core_customfield'},\n        {'key': 'yes'},\n        {'key': 'no'},\n    ])\n    .then(strings => {\n        return Notification.confirm(strings[0], strings[1], strings[2], strings[3], function() {\n            const pendingDeletePromise = new Pending('core_customfield/form:confirmDelete');\n            fetchMany([\n                {\n                    methodname: (type === 'field') ? 'core_customfield_delete_field' : 'core_customfield_delete_category',\n                    args: {id},\n                },\n                {methodname: 'core_customfield_reload_template', args: {component, area, itemid}}\n            ])[1]\n            .then(response => Templates.render('core_customfield/list', response))\n            .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n            .then(pendingDeletePromise.resolve)\n            .catch(Notification.exception);\n        });\n    })\n    .then(pendingPromise.resolve)\n    .catch(Notification.exception);\n};\n\n\n/**\n * Creates a new custom fields category with default name and updates the list\n *\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst createNewCategory = (component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:createNewCategory');\n    const promises = fetchMany([\n        {methodname: 'core_customfield_create_category', args: {component, area, itemid}},\n        {methodname: 'core_customfield_reload_template', args: {component, area, itemid}}\n    ]);\n\n    promises[1].then(response => Templates.render('core_customfield/list', response))\n    .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n    .then(() => pendingPromise.resolve())\n    .catch(Notification.exception);\n};\n\n/**\n * Create new custom field\n *\n * @param {HTMLElement} element\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst createNewField = (element, component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:createNewField');\n\n    const returnFocus = element.closest(\".action-menu\").querySelector(\".dropdown-toggle\");\n    const form = new ModalForm({\n        formClass: \"core_customfield\\\\field_config_form\",\n        args: {\n            categoryid: element.getAttribute('data-categoryid'),\n            type: element.getAttribute('data-type'),\n        },\n        modalConfig: {\n            title: getString('addingnewcustomfield', 'core_customfield', element.getAttribute('data-typename')),\n        },\n        returnFocus,\n    });\n\n    form.addEventListener(form.events.FORM_SUBMITTED, () => {\n        const pendingCreatedPromise = new Pending('core_customfield/form:createdNewField');\n        const promises = fetchMany([\n            {methodname: 'core_customfield_reload_template', args: {component: component, area: area, itemid: itemid}}\n        ]);\n\n        promises[0].then(response => Templates.render('core_customfield/list', response))\n        .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n        .then(() => pendingCreatedPromise.resolve())\n        .catch(() => window.location.reload());\n    });\n\n    form.show();\n\n    pendingPromise.resolve();\n};\n\n/**\n * Edit custom field\n *\n * @param {HTMLElement} element\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst editField = (element, component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:editField');\n\n    const form = new ModalForm({\n        formClass: \"core_customfield\\\\field_config_form\",\n        args: {\n            id: element.getAttribute('data-id'),\n        },\n        modalConfig: {\n            title: getString('editingfield', 'core_customfield', element.getAttribute('data-name')),\n        },\n        returnFocus: element,\n    });\n\n    form.addEventListener(form.events.FORM_SUBMITTED, () => {\n        const pendingCreatedPromise = new Pending('core_customfield/form:createdNewField');\n        const promises = fetchMany([\n            {methodname: 'core_customfield_reload_template', args: {component: component, area: area, itemid: itemid}}\n        ]);\n\n        promises[0].then(response => Templates.render('core_customfield/list', response))\n        .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n        .then(() => pendingCreatedPromise.resolve())\n        .catch(() => window.location.reload());\n    });\n\n    form.show();\n\n    pendingPromise.resolve();\n};\n\n/**\n * Fetch the category name from an inplace editable, given a child node of that field.\n *\n * @param {NodeElement} nodeElement\n * @returns {String}\n */\nconst getCategoryNameFor = nodeElement => nodeElement\n    .closest('[data-category-id]')\n    .find('[data-inplaceeditable][data-itemtype=category][data-component=core_customfield]')\n    .attr('data-value');\n\nconst setupSortableLists = rootNode => {\n    // Sort category.\n    const sortCat = new SortableList(\n        '#customfield_catlist .categorieslist',\n        {\n            moveHandlerSelector: '.movecategory [data-drag-type=move]',\n        }\n    );\n    sortCat.getElementName = nodeElement => Promise.resolve(getCategoryNameFor(nodeElement));\n\n    // Note: The sortable list currently uses jQuery events.\n    jQuery('[data-category-id]').on(SortableList.EVENTS.DROP, (evt, info) => {\n        if (info.positionChanged) {\n            const pendingPromise = new Pending('core_customfield/form:categoryid:on:sortablelist-drop');\n            fetchMany([{\n                methodname: 'core_customfield_move_category',\n                args: {\n                    id: info.element.data('category-id'),\n                    beforeid: info.targetNextElement.data('category-id')\n                }\n\n            }])[0]\n            .then(pendingPromise.resolve)\n            .catch(Notification.exception);\n        }\n        evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n    });\n\n    // Sort fields.\n    var sort = new SortableList(\n        '#customfield_catlist .fieldslist tbody',\n        {\n            moveHandlerSelector: '.movefield [data-drag-type=move]',\n        }\n    );\n\n    sort.getDestinationName = (parentElement, afterElement) => {\n        if (!afterElement.length) {\n            return getString('totopofcategory', 'customfield', getCategoryNameFor(parentElement));\n        } else if (afterElement.attr('data-field-name')) {\n            return getString('afterfield', 'customfield', afterElement.attr('data-field-name'));\n        } else {\n            return Promise.resolve('');\n        }\n    };\n\n    jQuery('[data-field-name]').on(SortableList.EVENTS.DROP, (evt, info) => {\n        if (info.positionChanged) {\n            const pendingPromise = new Pending('core_customfield/form:fieldname:on:sortablelist-drop');\n            fetchMany([{\n                methodname: 'core_customfield_move_field',\n                args: {\n                    id: info.element.data('field-id'),\n                    beforeid: info.targetNextElement.data('field-id'),\n                    categoryid: Number(info.targetList.closest('[data-category-id]').attr('data-category-id'))\n                },\n            }])[0]\n            .then(pendingPromise.resolve)\n            .catch(Notification.exception);\n        }\n        evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n    });\n\n    jQuery('[data-field-name]').on(SortableList.EVENTS.DRAG, evt => {\n        var pendingPromise = new Pending('core_customfield/form:fieldname:on:sortablelist-drag');\n\n        evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n\n        // Refreshing fields tables.\n        Templates.render('core_customfield/nofields', {})\n        .then(html => {\n            rootNode.querySelectorAll('.categorieslist > *')\n            .forEach(category => {\n                const fields = category.querySelectorAll('.field:not(.sortable-list-is-dragged)');\n                const noFields = category.querySelector('.nofields');\n\n                if (!fields.length && !noFields) {\n                    category.querySelector('tbody').innerHTML = html;\n                } else if (fields.length && noFields) {\n                    noFields.remove();\n                }\n            });\n            return;\n        })\n        .then(pendingPromise.resolve)\n        .catch(Notification.exception);\n    });\n\n    jQuery('[data-category-id], [data-field-name]').on(SortableList.EVENTS.DRAGSTART, (evt, info) => {\n        setTimeout(() => {\n            jQuery('.sortable-list-is-dragged').width(info.element.width());\n        }, 501);\n    });\n};\n\n/**\n * Initialise the custom fields manager.\n */\nexport const init = () => {\n    const rootNode = document.querySelector('#customfield_catlist');\n\n    const component = rootNode.dataset.component;\n    const area = rootNode.dataset.area;\n    const itemid = rootNode.dataset.itemid;\n\n    rootNode.addEventListener('click', e => {\n        const roleHolder = e.target.closest('[data-role]');\n        if (!roleHolder) {\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'deletefield') {\n            e.preventDefault();\n\n            confirmDelete(roleHolder.dataset.id, 'field', component, area, itemid);\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'deletecategory') {\n            e.preventDefault();\n\n            confirmDelete(roleHolder.dataset.id, 'category', component, area, itemid);\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'addnewcategory') {\n            e.preventDefault();\n            createNewCategory(component, area, itemid);\n\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'addfield') {\n            e.preventDefault();\n            createNewField(roleHolder, component, area, itemid);\n\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'editfield') {\n            e.preventDefault();\n            editField(roleHolder, component, area, itemid);\n\n            return;\n        }\n    });\n\n    setupSortableLists(rootNode, component, area, itemid);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","_modalform","_notification","_pending","_sortable_list","_templates","_jquery","confirmDelete","id","type","component","area","itemid","pendingPromise","Pending","getStrings","key","then","strings","Notification","confirm","pendingDeletePromise","fetchMany","methodname","args","response","Templates","render","html","js","replaceNode","jQuery","resolve","catch","exception","getCategoryNameFor","nodeElement","closest","find","attr","_exports","init","rootNode","document","querySelector","dataset","addEventListener","e","roleHolder","target","role","preventDefault","createNewCategory","element","returnFocus","form","ModalForm","formClass","categoryid","getAttribute","modalConfig","title","getString","get_string","events","FORM_SUBMITTED","pendingCreatedPromise","window","location","reload","show","createNewField","editField","SortableList","moveHandlerSelector","getElementName","Promise","on","EVENTS","DROP","evt","info","positionChanged","data","beforeid","targetNextElement","stopPropagation","getDestinationName","parentElement","afterElement","length","Number","targetList","DRAG","querySelectorAll","forEach","category","fields","noFields","remove","innerHTML","DRAGSTART","setTimeout","width","setupSortableLists"],"mappings":"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"}