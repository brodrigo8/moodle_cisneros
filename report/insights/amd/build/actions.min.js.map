{"version":3,"sources":["../src/actions.js"],"names":["define","$","Str","Ajax","Notification","Url","ModalFactory","ModalEvents","initBulk","rootNode","noItemsSelected","actionVisibleName","get_strings","key","component","then","strings","create","type","types","CANCEL","title","body","modal","show","catch","exception","executeAction","predictionIds","predictionContainers","actionName","call","methodname","args","predictionids","actionname","tableNode","forEach","el","closest","remove","find","length","params","contextid","data","modelid","window","location","assign","relativeUrl","on","e","preventDefault","action","currentTarget","text","trim","each","container","push","param","nitems","strs","SAVE_CANCEL","setSaveButtonText","getRoot","save"],"mappings":"AA4BAA,OAAM,2BAAC,CAAC,QAAD,CAAW,UAAX,CAAuB,WAAvB,CAAoC,mBAApC,CAAyD,UAAzD,CAAqE,oBAArE,CAA2F,mBAA3F,CAAD,CACE,SAASC,CAAT,CAAYC,CAAZ,CAAiBC,CAAjB,CAAuBC,CAAvB,CAAqCC,CAArC,CAA0CC,CAA1C,CAAwDC,CAAxD,CAAqE,CAEzE,MAAO,CAQHC,QAAQ,CAAE,kBAASC,CAAT,CAAmB,IAQrBC,CAAAA,CAAe,CAAG,SAASC,CAAT,CAA4B,CAC9C,MAAOT,CAAAA,CAAG,CAACU,WAAJ,CAAgB,CACf,CAACC,GAAG,CAAE,iBAAN,CAAyBC,SAAS,CAAE,iBAApC,CADe,CAAhB,EAEJC,IAFI,CAEC,SAASC,CAAT,CAAkB,CAClB,MAAOV,CAAAA,CAAY,CAACW,MAAb,CAAoB,CACvBC,IAAI,CAAEZ,CAAY,CAACa,KAAb,CAAmBC,MADF,CAEvBC,KAAK,CAAEV,CAFgB,CAGvBW,IAAI,CAAEN,CAAO,CAAC,CAAD,CAHU,CAApB,CAKd,CARM,EAQJD,IARI,CAQC,SAASQ,CAAT,CAAgB,CAChBA,CAAK,CAACC,IAAN,GACA,MAAOD,CAAAA,CACd,CAXM,EAWJE,KAXI,CAWErB,CAAY,CAACsB,SAXf,CAYV,CArBwB,CA+BrBC,CAAa,CAAG,SAASC,CAAT,CAAwBC,CAAxB,CAA8CC,CAA9C,CAA0D,CAE1E,MAAO3B,CAAAA,CAAI,CAAC4B,IAAL,CAAU,CACb,CACIC,UAAU,CAAE,iCADhB,CAEIC,IAAI,CAAE,CACFC,aAAa,CAAEN,CADb,CAEFO,UAAU,CAAEL,CAFV,CAFV,CADa,CAAV,EAQJ,CARI,EAQDf,IARC,CAQI,UAAW,CAGlB,GAAIqB,CAAAA,CAAS,GAAb,CACAP,CAAoB,CAACQ,OAArB,CAA6B,SAASC,CAAT,CAAa,CACtC,GAAI,KAAAF,CAAJ,CAAyB,CACrBA,CAAS,CAAGE,CAAE,CAACC,OAAH,CAAW,OAAX,CACf,CACDD,CAAE,CAACE,MAAH,EACH,CALD,EAOA,GAAuC,CAAnC,GAAAJ,CAAS,CAACK,IAAV,CAAe,OAAf,EAAwBC,MAA5B,CAA0C,CACtC,GAAIC,CAAAA,CAAM,CAAG,CACTC,SAAS,CAAER,CAAS,CAACG,OAAV,CAAkB,uBAAlB,EAA2CM,IAA3C,CAAgD,YAAhD,CADF,CAETC,OAAO,CAAEV,CAAS,CAACG,OAAV,CAAkB,uBAAlB,EAA2CM,IAA3C,CAAgD,UAAhD,CAFA,CAAb,CAIAE,MAAM,CAACC,QAAP,CAAgBC,MAAhB,CAAuB5C,CAAG,CAAC6C,WAAJ,CAAgB,8BAAhB,CAAgDP,CAAhD,IAAvB,CACH,CAEJ,CA3BM,EA2BJlB,KA3BI,CA2BErB,CAAY,CAACsB,SA3Bf,CA4BV,CA7DwB,CA+DzBzB,CAAC,CAACQ,CAAQ,CAAG,yBAAZ,CAAD,CAAwC0C,EAAxC,CAA2C,OAA3C,CAAoD,SAASC,CAAT,CAAY,CAC5DA,CAAC,CAACC,cAAF,GAD4D,GAExDC,CAAAA,CAAM,CAAGrD,CAAC,CAACmD,CAAC,CAACG,aAAH,CAF8C,CAGxDzB,CAAU,CAAGwB,CAAM,CAACT,IAAP,CAAY,iBAAZ,CAH2C,CAIxDlC,CAAiB,CAAG2C,CAAM,CAACE,IAAP,GAAcC,IAAd,EAJoC,CAMxD7B,CAAa,CAAG,EANwC,CAOxDC,CAAoB,CAAG,EAPiC,CAS5D5B,CAAC,CAAC,iGAAD,CAAD,CAAiGyD,IAAjG,CAAsG,UAAW,CAC7G,GAAIC,CAAAA,CAAS,CAAG1D,CAAC,CAAC,IAAD,CAAD,CAAQsC,OAAR,CAAgB,2BAAhB,CAAhB,CACAV,CAAoB,CAAC+B,IAArB,CAA0BD,CAA1B,EACA/B,CAAa,CAACgC,IAAd,CAAmBD,CAAS,CAACd,IAAV,CAAe,eAAf,CAAnB,CACH,CAJD,EAMA,GAA6B,CAAzB,GAAAjB,CAAa,CAACc,MAAlB,CAAgC,CAE5B,MAAOhC,CAAAA,CAAe,CAACC,CAAD,CACzB,CAED,GAAIK,CAAAA,CAAO,CAAG,EAAd,CACA,MAAOd,CAAAA,CAAG,CAACU,WAAJ,CAAgB,CAAC,CACpBC,GAAG,CAAE,mBADe,CAEpBC,SAAS,CAAE,iBAFS,CAGpB+C,KAAK,CAAE,CACHP,MAAM,CAAE3C,CADL,CAEHmD,MAAM,CAAElC,CAAa,CAACc,MAFnB,CAHa,CAAD,CAOpB,CACC7B,GAAG,CAAE,SADN,CAECC,SAAS,CAAE,QAFZ,CAPoB,CAAhB,EAWLC,IAXK,CAWA,SAASgD,CAAT,CAAe,CAClB/C,CAAO,CAAG+C,CAAV,CACA,MAAOzD,CAAAA,CAAY,CAACW,MAAb,CAAoB,CACvBC,IAAI,CAAEZ,CAAY,CAACa,KAAb,CAAmB6C,WADF,CAEvB3C,KAAK,CAAEV,CAFgB,CAGvBW,IAAI,CAAEN,CAAO,CAAC,CAAD,CAHU,CAApB,CAKV,CAlBM,EAkBJD,IAlBI,CAkBC,SAASQ,CAAT,CAAgB,CACpBA,CAAK,CAAC0C,iBAAN,CAAwBjD,CAAO,CAAC,CAAD,CAA/B,EACAO,CAAK,CAACC,IAAN,GACAD,CAAK,CAAC2C,OAAN,GAAgBf,EAAhB,CAAmB5C,CAAW,CAAC4D,IAA/B,CAAqC,UAAW,CAE5C,MAAOxC,CAAAA,CAAa,CAACC,CAAD,CAAgBC,CAAhB,CAAsCC,CAAtC,CACvB,CAHD,EAKA,MAAOP,CAAAA,CACV,CA3BM,EA2BJE,KA3BI,CA2BErB,CAAY,CAACsB,SA3Bf,CA4BV,CAjDD,CAkDH,CAzHE,CA2HV,CA9HK,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to manage report insights actions that are executed using AJAX.\n *\n * @package    report_insights\n * @copyright  2017 David Monllao {@link http://www.davidmonllao.com}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * This module manages prediction actions that require AJAX requests.\n *\n * @module report_insights/actions\n */\ndefine(['jquery', 'core/str', 'core/ajax', 'core/notification', 'core/url', 'core/modal_factory', 'core/modal_events'],\n        function($, Str, Ajax, Notification, Url, ModalFactory, ModalEvents) {\n\n    return {\n\n        /**\n         * Attach on click handlers for bulk actions.\n         *\n         * @param {String} rootNode\n         * @access public\n         */\n        initBulk: function(rootNode) {\n\n            /**\n             * Show the no items selected note.\n             *\n             * @param  {String} actionVisibleName\n             * @return {Promise}\n             */\n            var noItemsSelected = function(actionVisibleName) {\n                return Str.get_strings([\n                        {key: 'noitemsselected', component: 'report_insights'},\n                ]).then(function(strings) {\n                        return ModalFactory.create({\n                            type: ModalFactory.types.CANCEL,\n                            title: actionVisibleName,\n                            body: strings[0],\n                        });\n                }).then(function(modal) {\n                        modal.show();\n                        return modal;\n                }).catch(Notification.exception);\n            };\n\n            /**\n             * Executes the provided action.\n             *\n             * @param  {Array}  predictionIds\n             * @param  {Array}  predictionContainers\n             * @param  {String} actionName\n             * @return {Promise}\n             */\n            var executeAction = function(predictionIds, predictionContainers, actionName) {\n\n                return Ajax.call([\n                    {\n                        methodname: 'report_insights_action_executed',\n                        args: {\n                            predictionids: predictionIds,\n                            actionname: actionName\n                        }\n                    }\n                ])[0].then(function() {\n                    // Remove the selected elements from the list.\n\n                    var tableNode = false;\n                    predictionContainers.forEach(function(el) {\n                        if (tableNode === false) {\n                            tableNode = el.closest('table');\n                        }\n                        el.remove();\n                    });\n\n                    if (tableNode.find('tbody').length === 0) {\n                        let params = {\n                            contextid: tableNode.closest('div.insight-container').data('context-id'),\n                            modelid: tableNode.closest('div.insight-container').data('model-id')\n                        };\n                        window.location.assign(Url.relativeUrl(\"report/insights/insights.php\", params, false));\n                    }\n                    return;\n                }).catch(Notification.exception);\n            };\n\n            $(rootNode + ' [data-bulk-actionname]').on('click', function(e) {\n                e.preventDefault();\n                var action = $(e.currentTarget);\n                var actionName = action.data('bulk-actionname');\n                var actionVisibleName = action.text().trim();\n\n                var predictionIds = [];\n                var predictionContainers = [];\n\n                $('.insights-list input[data-togglegroup^=\"insight-bulk-action-\"][data-toggle=\"slave\"]:checked').each(function() {\n                    var container = $(this).closest('tbody[data-prediction-id]');\n                    predictionContainers.push(container);\n                    predictionIds.push(container.data('prediction-id'));\n                });\n\n                if (predictionIds.length === 0) {\n                    // No items selected message.\n                    return noItemsSelected(actionVisibleName);\n                }\n\n                var strings = [];\n                return Str.get_strings([{\n                    key: 'confirmbulkaction',\n                    component: 'report_insights',\n                    param: {\n                        action: actionVisibleName,\n                        nitems: predictionIds.length\n                    }\n                }, {\n                    key: 'confirm',\n                    component: 'moodle'\n                }]\n                ).then(function(strs) {\n                    strings = strs;\n                    return ModalFactory.create({\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        title: actionVisibleName,\n                        body: strings[0],\n                    });\n                }).then(function(modal) {\n                    modal.setSaveButtonText(strings[1]);\n                    modal.show();\n                    modal.getRoot().on(ModalEvents.save, function() {\n                        // The action is now confirmed, sending an action for it.\n                        return executeAction(predictionIds, predictionContainers, actionName);\n                    });\n\n                    return modal;\n                }).catch(Notification.exception);\n            });\n        },\n    };\n});\n"],"file":"actions.min.js"}