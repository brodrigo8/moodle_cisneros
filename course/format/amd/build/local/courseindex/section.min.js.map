{"version":3,"file":"section.min.js","sources":["../../../src/local/courseindex/section.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Course index section component.\n *\n * This component is used to control specific course section interactions like drag and drop.\n *\n * @module     core_courseformat/local/courseindex/section\n * @class      core_courseformat/local/courseindex/section\n * @copyright  2021 Ferran Recio <ferran@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport SectionTitle from 'core_courseformat/local/courseindex/sectiontitle';\nimport DndSection from 'core_courseformat/local/courseeditor/dndsection';\n\nexport default class Component extends DndSection {\n\n    /**\n     * Constructor hook.\n     */\n    create() {\n        // Optional component name for debugging.\n        this.name = 'courseindex_section';\n        // Default query selectors.\n        this.selectors = {\n            SECTION_ITEM: `[data-for='section_item']`,\n            SECTION_TITLE: `[data-for='section_title']`,\n            CM_LAST: `[data-for=\"cm\"]:last-child`,\n        };\n        // Default classes to toggle on refresh.\n        this.classes = {\n            SECTIONHIDDEN: 'dimmed',\n            SECTIONCURRENT: 'current',\n            LOCKED: 'editinprogress',\n            RESTRICTIONS: 'restrictions',\n            PAGEITEM: 'pageitem',\n        };\n\n        // We need our id to watch specific events.\n        this.id = this.element.dataset.id;\n        this.isPageItem = false;\n    }\n\n    /**\n     * Static method to create a component instance form the mustahce template.\n     *\n     * @param {string} target the DOM main element or its ID\n     * @param {object} selectors optional css selector overrides\n     * @return {Component}\n     */\n    static init(target, selectors) {\n        return new this({\n            element: document.getElementById(target),\n            selectors,\n        });\n    }\n\n    /**\n     * Initial state ready method.\n     *\n     * @param {Object} state the initial state\n     */\n    stateReady(state) {\n        this.configState(state);\n        const sectionItem = this.getElement(this.selectors.SECTION_ITEM);\n        // Drag and drop is only available for components compatible course formats.\n        if (this.reactive.isEditing && this.reactive.supportComponents) {\n            // Init the inner dragable element passing the full section as affected region.\n            const titleitem = new SectionTitle({\n                ...this,\n                element: sectionItem,\n                fullregion: this.element,\n            });\n            this.configDragDrop(titleitem);\n        }\n        // Check if the current url is the section url.\n        const section = state.section.get(this.id);\n        if (window.location.href == section.sectionurl.replace(/&amp;/g, \"&\")) {\n            this.reactive.dispatch('setPageItem', 'section', this.id);\n            sectionItem.scrollIntoView();\n        }\n    }\n\n    /**\n     * Component watchers.\n     *\n     * @returns {Array} of watchers\n     */\n    getWatchers() {\n        return [\n            {watch: `section[${this.id}]:deleted`, handler: this.remove},\n            {watch: `section[${this.id}]:updated`, handler: this._refreshSection},\n            {watch: `course.pageItem:updated`, handler: this._refreshPageItem},\n        ];\n    }\n\n    /**\n     * Get the last CM element of that section.\n     *\n     * @returns {element|null}\n     */\n    getLastCm() {\n        return this.getElement(this.selectors.CM_LAST);\n    }\n\n    /**\n     * Update a course index section using the state information.\n     *\n     * @param {Object} param details the update details.\n     * @param {Object} param.element the section element\n     */\n    _refreshSection({element}) {\n        // Update classes.\n        const sectionItem = this.getElement(this.selectors.SECTION_ITEM);\n        sectionItem.classList.toggle(this.classes.SECTIONHIDDEN, !element.visible);\n        sectionItem.classList.toggle(this.classes.RESTRICTIONS, element.hasrestrictions ?? false);\n        this.element.classList.toggle(this.classes.SECTIONCURRENT, element.current);\n        this.element.classList.toggle(this.classes.DRAGGING, element.dragging ?? false);\n        this.element.classList.toggle(this.classes.LOCKED, element.locked ?? false);\n        this.locked = element.locked;\n        // Update title.\n        this.getElement(this.selectors.SECTION_TITLE).innerHTML = element.title;\n    }\n\n    /**\n     * Handle a page item update.\n     *\n     * @param {Object} details the update details\n     * @param {Object} details.state the state data.\n     * @param {Object} details.element the course state data.\n     */\n    _refreshPageItem({element, state}) {\n        if (!element.pageItem) {\n            return;\n        }\n        if (element.pageItem.sectionId !== this.id && this.isPageItem) {\n            this.pageItem = false;\n            this.getElement(this.selectors.SECTION_ITEM).classList.remove(this.classes.PAGEITEM);\n            return;\n        }\n        const section = state.section.get(this.id);\n        if (section.indexcollapsed && !element.pageItem?.isStatic) {\n            this.pageItem = (element.pageItem?.sectionId == this.id);\n        } else {\n            this.pageItem = (element.pageItem.type == 'section' && element.pageItem.id == this.id);\n        }\n        const sectionItem = this.getElement(this.selectors.SECTION_ITEM);\n        sectionItem.classList.toggle(this.classes.PAGEITEM, this.pageItem ?? false);\n        if (this.pageItem && !this.reactive.isEditing) {\n            this.element.scrollIntoView({block: \"nearest\"});\n        }\n    }\n}\n"],"names":["_interopRequireDefault","obj","__esModule","default","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","value","_toPropertyKey","configurable","writable","_classCallCheck","instance","Constructor","TypeError","_defineProperties","props","descriptor","arg","input","hint","_typeof","prim","Symbol","toPrimitive","undefined","res","call","String","Number","_toPrimitive","_setPrototypeOf","o","p","setPrototypeOf","bind","__proto__","_createSuper","Derived","hasNativeReflectConstruct","Reflect","construct","sham","Proxy","Boolean","prototype","valueOf","e","_isNativeReflectConstruct","result","Super","_getPrototypeOf","NewTarget","this","constructor","_possibleConstructorReturn","self","ReferenceError","_assertThisInitialized","getPrototypeOf","_sectiontitle","Component","_DndSection","subClass","superClass","create","_inherits","protoProps","staticProps","_super","selectors","element","document","getElementById","name","SECTION_ITEM","SECTION_TITLE","CM_LAST","classes","SECTIONHIDDEN","SECTIONCURRENT","LOCKED","RESTRICTIONS","PAGEITEM","id","dataset","isPageItem","state","configState","sectionItem","getElement","reactive","isEditing","supportComponents","titleitem","SectionTitle","fullregion","configDragDrop","section","get","window","location","href","sectionurl","replace","dispatch","scrollIntoView","watch","concat","handler","remove","_refreshSection","_refreshPageItem","_ref","_element$hasrestricti","_element$dragging","_element$locked","classList","toggle","visible","hasrestrictions","current","DRAGGING","dragging","locked","innerHTML","title","_ref2","_element$pageItem","_this$pageItem","pageItem","sectionId","_element$pageItem2","indexcollapsed","isStatic","type","block","_dndsection","_exports"],"mappings":"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"}