define(["jquery","core/templates","core/notification","core/ajax","core/str","core/yui"],function(a,b,c,d,e){function f(a){var b=[];"undefined"==typeof a&&(a=!1);for(var c in q){var d={typeVal:c,typeName:q[c]};a!==!1&&c==a&&(d.selected=!0),b.push(d)}return b}function g(){var e=d.call([{methodname:"mod_threesixty_get_questions",args:{}}]);e[0].done(function(d){r=d.questions;var e={pickerMode:p,questions:j(r)};b.render("mod_threesixty/question_list",e).done(function(b){a("#questionListWrapper").html(b),l()}).fail(c.exception)}).fail(c.exception)}function h(d){e.get_string("addanewquestion","mod_threesixty").done(function(e){var g={},h=a("<label/>").append(e);if("undefined"!=typeof d)for(var j in r){var k=r[j];if(k.id==d){g.question=k.question,g.type=k.type;break}}else d=!1;g.questionTypes=f(g.type),console.log(r),b.render("mod_threesixty/item_edit",g).done(function(a){i(h,a,d)}).fail(c.exception)}).fail(c.exception)}function i(b,f,h){var i=new M.core.dialogue({modal:!0,headerContent:b,bodyContent:'<div id="question-input-dialogue-container"/>',draggable:!0,center:!0});i.show(),i.after("visibleChange",function(a){a.prevVal&&!a.newVal&&this.destroy()},i),a("#question-input-dialogue-container").html(f),a("#btn-cancel-question-input").click(function(){i.hide()}),a("#btn-save-question").click(function(b){b.preventDefault();var f=a("#question-input").val().trim();if(!f)return void e.get_string("requiredelement","form").done(function(b){var c=a("<div/>").append(b).attr("class","alert alert-error").attr("role","alert");a(".error-container").html(c)}).fail(c.exception);var j=a("#question-type-select").val(),k={question:f,type:j},l="mod_threesixty_add_question";h!==!1&&(l="mod_threesixty_update_question",k.id=h);var m=d.call([{methodname:l,args:k}]);m[0].done(function(){i.hide(),g()}).fail(c.exception)})}function j(a){for(var b in a){var c=a[b];o.indexOf(a[b].id)!==-1&&(c.checked=!0)}return a}function k(b,e){var f=a("<label/>").append(b),g=new M.core.dialogue({modal:!0,headerContent:f,bodyContent:e,width:"95%",center:!0});g.show(),a("#btn-question-bank-cancel").click(function(){g.hide(),g.destroy()}),a("#btn-question-bank-add").click(function(){h()}),a("#btn-question-bank-done").click(function(){var b=!1;if(a.each(n,function(a,c){o.indexOf(c)==-1&&(b=!0)}),b||a.each(o,function(a,c){n.indexOf(c)==-1&&(b=!0)}),b){var e={threesixtyid:p,questionids:o},f=d.call([{methodname:"mod_threesixty_set_items",args:e}]);f[0].done(function(){g.hide(),g.destroy(),require(["mod_threesixty/edit_items"],function(a){a.refreshItemList()})}).fail(c.exception)}else g.hide(),g.destroy()}),l()}function l(){a(".question-checkbox").click(function(){var b=parseInt(this.getAttribute("data-questionid"));if(a(this).is(":checked"))o.push(b);else{var c=o.indexOf(b);c>-1&&o.splice(c,1)}}),a(".edit-question-button").click(function(){var b=a(this).data("questionid");h(b)}),a(".delete-question-button").click(function(){var a=this.getAttribute("data-questionid"),b=d.call([{methodname:"mod_threesixty_delete_question",args:{id:a}}]);b[0].done(function(){g()}).fail(c.exception)})}function m(){var a={pickerMode:p},f=d.call([{methodname:"mod_threesixty_get_questions",args:{}}]);f[0].done(function(d){r=d.questions,a.questions=j(r),b.render("mod_threesixty/question_bank",a).done(function(a){e.get_string("labelpickfromquestionbank","mod_threesixty").done(function(b){k(b,a)}).fail(c.exception)}).fail(c.exception)}).fail(c.exception)}var n,o,p,q,r=[],s=function(a){p=a;var b=[{methodname:"mod_threesixty_get_question_types",args:{}}];p&&b.push({methodname:"mod_threesixty_get_items",args:{threesixtyid:p}});var e=d.call(b);e[0].done(function(a){q=a.questiontypes,p?(o=[],n=[],e[1].done(function(a){var b=a.items;for(var c in b)o.push(b[c].questionid),n.push(b[c].questionid);m()}).fail(c.exception)):m()}).fail(c.exception)};return s});