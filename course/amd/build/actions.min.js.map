{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Various actions on modules and sections in the editing mode - hiding, duplicating, deleting, etc.\n *\n * @module     core_course/actions\n * @copyright  2016 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.3\n */\ndefine(\n    [\n        'jquery',\n        'core/ajax',\n        'core/templates',\n        'core/notification',\n        'core/str',\n        'core/url',\n        'core/yui',\n        'core/modal_factory',\n        'core/modal_events',\n        'core/key_codes',\n        'core/log',\n        'core_courseformat/courseeditor',\n        'core/event_dispatcher',\n        'core_course/events'\n    ],\n    function(\n        $,\n        ajax,\n        templates,\n        notification,\n        str,\n        url,\n        Y,\n        ModalFactory,\n        ModalEvents,\n        KeyCodes,\n        log,\n        editor,\n        EventDispatcher,\n        CourseEvents\n    ) {\n\n        // Eventually, core_courseformat/local/content/actions will handle all actions for\n        // component compatible formats and the default actions.js won't be necessary anymore.\n        // Meanwhile, we filter the migrated actions.\n        const componentActions = [\n            'moveSection', 'moveCm', 'addSection', 'deleteSection', 'cmDelete', 'cmDuplicate', 'sectionHide', 'sectionShow',\n            'cmHide', 'cmShow', 'cmStealth', 'sectionHighlight', 'sectionUnhighlight',\n        ];\n\n        // The course reactive instance.\n        const courseeditor = editor.getCurrentCourseEditor();\n\n        // The current course format name (loaded on init).\n        let formatname;\n\n        var CSS = {\n            EDITINPROGRESS: 'editinprogress',\n            SECTIONDRAGGABLE: 'sectiondraggable',\n            EDITINGMOVE: 'editing_move'\n        };\n        var SELECTOR = {\n            ACTIVITYLI: 'li.activity',\n            ACTIONAREA: '.actions',\n            ACTIVITYACTION: 'a.cm-edit-action',\n            MENU: '.moodle-actionmenu[data-enhance=moodle-core-actionmenu]',\n            TOGGLE: '.toggle-display,.dropdown-toggle',\n            SECTIONLI: 'li.section',\n            SECTIONACTIONMENU: '.section_action_menu',\n            ADDSECTIONS: '.changenumsections [data-add-sections]',\n            SECTIONBADGES: '[data-region=\"sectionbadges\"]',\n        };\n\n        Y.use('moodle-course-coursebase', function() {\n            var courseformatselector = M.course.format.get_section_selector();\n            if (courseformatselector) {\n                SELECTOR.SECTIONLI = courseformatselector;\n            }\n        });\n\n        /**\n         * Dispatch event wrapper.\n         *\n         * Old jQuery events will be replaced by native events gradually.\n         *\n         * @method dispatchEvent\n         * @param {String} eventName The name of the event\n         * @param {Object} detail Any additional details to pass into the eveent\n         * @param {Node|HTMLElement} container The point at which to dispatch the event\n         * @param {Object} options\n         * @param {Boolean} options.bubbles Whether to bubble up the DOM\n         * @param {Boolean} options.cancelable Whether preventDefault() can be called\n         * @param {Boolean} options.composed Whether the event can bubble across the ShadowDOM boundary\n         * @returns {CustomEvent}\n         */\n        const dispatchEvent = function(eventName, detail, container, options) {\n            // Most actions still uses jQuery node instead of regular HTMLElement.\n            if (!(container instanceof Element) && container.get !== undefined) {\n                container = container.get(0);\n            }\n            return EventDispatcher.dispatchEvent(eventName, detail, container, options);\n        };\n\n        /**\n         * Wrapper for Y.Moodle.core_course.util.cm.getId\n         *\n         * @param {JQuery} element\n         * @returns {Integer}\n         */\n        var getModuleId = function(element) {\n            // Check if we have a data-id first.\n            const item = element.get(0);\n            if (item.dataset.id) {\n                return item.dataset.id;\n            }\n            // Use YUI way if data-id is not present.\n            let id;\n            Y.use('moodle-course-util', function(Y) {\n                id = Y.Moodle.core_course.util.cm.getId(Y.Node(item));\n            });\n            return id;\n        };\n\n        /**\n         * Wrapper for Y.Moodle.core_course.util.cm.getName\n         *\n         * @param {JQuery} element\n         * @returns {String}\n         */\n        var getModuleName = function(element) {\n            var name;\n            Y.use('moodle-course-util', function(Y) {\n                name = Y.Moodle.core_course.util.cm.getName(Y.Node(element.get(0)));\n            });\n            // Check if we have the name in the course state.\n            const state = courseeditor.state;\n            const cmid = getModuleId(element);\n            if (!name && state && cmid) {\n                name = state.cm.get(cmid)?.name;\n            }\n            return name;\n        };\n\n        /**\n         * Wrapper for M.util.add_spinner for an activity\n         *\n         * @param {JQuery} activity\n         * @returns {Node}\n         */\n        var addActivitySpinner = function(activity) {\n            activity.addClass(CSS.EDITINPROGRESS);\n            var actionarea = activity.find(SELECTOR.ACTIONAREA).get(0);\n            if (actionarea) {\n                var spinner = M.util.add_spinner(Y, Y.Node(actionarea));\n                spinner.show();\n                // Lock the activity state element.\n                if (activity.data('id') !== undefined) {\n                    courseeditor.dispatch('cmLock', [activity.data('id')], true);\n                }\n                return spinner;\n            }\n            return null;\n        };\n\n        /**\n         * Wrapper for M.util.add_spinner for a section\n         *\n         * @param {JQuery} sectionelement\n         * @returns {Node}\n         */\n        var addSectionSpinner = function(sectionelement) {\n            sectionelement.addClass(CSS.EDITINPROGRESS);\n            var actionarea = sectionelement.find(SELECTOR.SECTIONACTIONMENU).get(0);\n            if (actionarea) {\n                var spinner = M.util.add_spinner(Y, Y.Node(actionarea));\n                spinner.show();\n                // Lock the section state element.\n                if (sectionelement.data('id') !== undefined) {\n                    courseeditor.dispatch('sectionLock', [sectionelement.data('id')], true);\n                }\n                return spinner;\n            }\n            return null;\n        };\n\n        /**\n         * Wrapper for M.util.add_lightbox\n         *\n         * @param {JQuery} sectionelement\n         * @returns {Node}\n         */\n        var addSectionLightbox = function(sectionelement) {\n            const item = sectionelement.get(0);\n            var lightbox = M.util.add_lightbox(Y, Y.Node(item));\n            if (item.dataset.for == 'section' && item.dataset.id) {\n                courseeditor.dispatch('sectionLock', [item.dataset.id], true);\n                lightbox.setAttribute('data-state', 'section');\n                lightbox.setAttribute('data-state-id', item.dataset.id);\n            }\n            lightbox.show();\n            return lightbox;\n        };\n\n        /**\n         * Removes the spinner element\n         *\n         * @param {JQuery} element\n         * @param {Node} spinner\n         * @param {Number} delay\n         */\n        var removeSpinner = function(element, spinner, delay) {\n            window.setTimeout(function() {\n                element.removeClass(CSS.EDITINPROGRESS);\n                if (spinner) {\n                    spinner.hide();\n                }\n                // Unlock the state element.\n                if (element.data('id') !== undefined) {\n                    const mutation = (element.data('for') === 'section') ? 'sectionLock' : 'cmLock';\n                    courseeditor.dispatch(mutation, [element.data('id')], false);\n                }\n            }, delay);\n        };\n\n        /**\n         * Removes the lightbox element\n         *\n         * @param {Node} lightbox lighbox YUI element returned by addSectionLightbox\n         * @param {Number} delay\n         */\n        var removeLightbox = function(lightbox, delay) {\n            if (lightbox) {\n                window.setTimeout(function() {\n                    lightbox.hide();\n                    // Unlock state if necessary.\n                    if (lightbox.getAttribute('data-state')) {\n                        courseeditor.dispatch(\n                            `${lightbox.getAttribute('data-state')}Lock`,\n                            [lightbox.getAttribute('data-state-id')],\n                            false\n                        );\n                    }\n                }, delay);\n            }\n        };\n\n        /**\n         * Initialise action menu for the element (section or module)\n         *\n         * @param {String} elementid CSS id attribute of the element\n         */\n        var initActionMenu = function(elementid) {\n            // Initialise action menu in the new activity.\n            Y.use('moodle-course-coursebase', function() {\n                M.course.coursebase.invoke_function('setup_for_resource', '#' + elementid);\n            });\n            if (M.core.actionmenu && M.core.actionmenu.newDOMNode) {\n                M.core.actionmenu.newDOMNode(Y.one('#' + elementid));\n            }\n        };\n\n        /**\n         * Returns focus to the element that was clicked or \"Edit\" link if element is no longer visible.\n         *\n         * @param {String} elementId CSS id attribute of the element\n         * @param {String} action data-action property of the element that was clicked\n         */\n        var focusActionItem = function(elementId, action) {\n            var mainelement = $('#' + elementId);\n            var selector = '[data-action=' + action + ']';\n            if (action === 'groupsseparate' || action === 'groupsvisible' || action === 'groupsnone') {\n                // New element will have different data-action.\n                selector = '[data-action=groupsseparate],[data-action=groupsvisible],[data-action=groupsnone]';\n            }\n            if (mainelement.find(selector).is(':visible')) {\n                mainelement.find(selector).focus();\n            } else {\n                // Element not visible, focus the \"Edit\" link.\n                mainelement.find(SELECTOR.MENU).find(SELECTOR.TOGGLE).focus();\n            }\n        };\n\n        /**\n         * Find next <a> after the element\n         *\n         * @param {JQuery} mainElement element that is about to be deleted\n         * @returns {JQuery}\n         */\n        var findNextFocusable = function(mainElement) {\n            var tabables = $(\"a:visible\");\n            var isInside = false;\n            var foundElement = null;\n            tabables.each(function() {\n                if ($.contains(mainElement[0], this)) {\n                    isInside = true;\n                } else if (isInside) {\n                    foundElement = this;\n                    return false; // Returning false in .each() is equivalent to \"break;\" inside the loop in php.\n                }\n                return true;\n            });\n            return foundElement;\n        };\n\n        /**\n         * Performs an action on a module (moving, deleting, duplicating, hiding, etc.)\n         *\n         * @param {JQuery} moduleElement activity element we perform action on\n         * @param {Number} cmid\n         * @param {JQuery} target the element (menu item) that was clicked\n         */\n        var editModule = function(moduleElement, cmid, target) {\n            var action = target.attr('data-action');\n            var spinner = addActivitySpinner(moduleElement);\n            var promises = ajax.call([{\n                methodname: 'core_course_edit_module',\n                args: {id: cmid,\n                    action: action,\n                    sectionreturn: target.attr('data-sectionreturn') ? target.attr('data-sectionreturn') : 0\n                }\n            }], true);\n\n            var lightbox;\n            if (action === 'duplicate') {\n                lightbox = addSectionLightbox(target.closest(SELECTOR.SECTIONLI));\n            }\n            $.when.apply($, promises)\n                .done(function(data) {\n                    var elementToFocus = findNextFocusable(moduleElement);\n                    moduleElement.replaceWith(data);\n                    let affectedids = [];\n                    // Initialise action menu for activity(ies) added as a result of this.\n                    $('<div>' + data + '</div>').find(SELECTOR.ACTIVITYLI).each(function(index) {\n                        initActionMenu($(this).attr('id'));\n                        if (index === 0) {\n                            focusActionItem($(this).attr('id'), action);\n                            elementToFocus = null;\n                        }\n                        // Save any activity id in cmids.\n                        affectedids.push(getModuleId($(this)));\n                    });\n                    // In case of activity deletion focus the next focusable element.\n                    if (elementToFocus) {\n                        elementToFocus.focus();\n                    }\n                    // Remove spinner and lightbox with a delay.\n                    removeSpinner(moduleElement, spinner, 400);\n                    removeLightbox(lightbox, 400);\n                    // Trigger event that can be observed by course formats.\n                    moduleElement.trigger($.Event('coursemoduleedited', {ajaxreturn: data, action: action}));\n\n                    // Modify cm state.\n                    courseeditor.dispatch('legacyActivityAction', action, cmid, affectedids);\n\n                }).fail(function(ex) {\n                    // Remove spinner and lightbox.\n                    removeSpinner(moduleElement, spinner);\n                    removeLightbox(lightbox);\n                    // Trigger event that can be observed by course formats.\n                    var e = $.Event('coursemoduleeditfailed', {exception: ex, action: action});\n                    moduleElement.trigger(e);\n                    if (!e.isDefaultPrevented()) {\n                        notification.exception(ex);\n                    }\n                });\n        };\n\n        /**\n         * Requests html for the module via WS core_course_get_module and updates the module on the course page\n         *\n         * Used after d&d of the module to another section\n         *\n         * @param {JQuery|Element} element\n         * @param {Number} cmid\n         * @param {Number} sectionreturn\n         * @return {Promise} the refresh promise\n         */\n        var refreshModule = function(element, cmid, sectionreturn) {\n\n            if (sectionreturn === undefined) {\n                sectionreturn = courseeditor.sectionReturn;\n            }\n\n            const activityElement = $(element);\n            var spinner = addActivitySpinner(activityElement);\n            var promises = ajax.call([{\n                methodname: 'core_course_get_module',\n                args: {id: cmid, sectionreturn: sectionreturn}\n            }], true);\n\n            return new Promise((resolve, reject) => {\n                $.when.apply($, promises)\n                    .done(function(data) {\n                        removeSpinner(activityElement, spinner, 400);\n                        replaceActivityHtmlWith(data);\n                        resolve(data);\n                    }).fail(function() {\n                        removeSpinner(activityElement, spinner);\n                        reject();\n                    });\n            });\n        };\n\n        /**\n         * Requests html for the section via WS core_course_edit_section and updates the section on the course page\n         *\n         * @param {JQuery|Element} element\n         * @param {Number} sectionid\n         * @param {Number} sectionreturn\n         * @return {Promise} the refresh promise\n         */\n        var refreshSection = function(element, sectionid, sectionreturn) {\n\n            if (sectionreturn === undefined) {\n                sectionreturn = courseeditor.sectionReturn;\n            }\n\n            const sectionElement = $(element);\n            const action = 'refresh';\n            const promises = ajax.call([{\n                methodname: 'core_course_edit_section',\n                args: {id: sectionid, action, sectionreturn},\n            }], true);\n\n            var spinner = addSectionSpinner(sectionElement);\n            return new Promise((resolve, reject) => {\n                $.when.apply($, promises)\n                    .done(dataencoded => {\n\n                        removeSpinner(sectionElement, spinner);\n                        const data = $.parseJSON(dataencoded);\n\n                        const newSectionElement = $(data.content);\n                        sectionElement.replaceWith(newSectionElement);\n\n                        // Init modules menus.\n                        $(`${SELECTOR.SECTIONLI}#${sectionid} ${SELECTOR.ACTIVITYLI}`).each(\n                            (index, activity) => {\n                                initActionMenu(activity.data('id'));\n                            }\n                        );\n\n                        // Trigger event that can be observed by course formats.\n                        const event = dispatchEvent(\n                            CourseEvents.sectionRefreshed,\n                            {\n                                ajaxreturn: data,\n                                action: action,\n                                newSectionElement: newSectionElement.get(0),\n                            },\n                            newSectionElement\n                        );\n\n                        if (!event.defaultPrevented) {\n                            defaultEditSectionHandler(\n                                newSectionElement, $(SELECTOR.SECTIONLI + '#' + sectionid),\n                                data,\n                                formatname,\n                                sectionid\n                            );\n                        }\n                        resolve(data);\n                    }).fail(ex => {\n                        // Trigger event that can be observed by course formats.\n                        const event = dispatchEvent(\n                            'coursesectionrefreshfailed',\n                            {exception: ex, action: action},\n                            sectionElement\n                        );\n                        if (!event.defaultPrevented) {\n                            notification.exception(ex);\n                        }\n                        reject();\n                    });\n            });\n        };\n\n        /**\n         * Displays the delete confirmation to delete a module\n         *\n         * @param {JQuery} mainelement activity element we perform action on\n         * @param {function} onconfirm function to execute on confirm\n         */\n        var confirmDeleteModule = function(mainelement, onconfirm) {\n            var modtypename = mainelement.attr('class').match(/modtype_([^\\s]*)/)[1];\n            var modulename = getModuleName(mainelement);\n\n            str.get_string('pluginname', modtypename).done(function(pluginname) {\n                var plugindata = {\n                    type: pluginname,\n                    name: modulename\n                };\n                str.get_strings([\n                    {key: 'confirm', component: 'core'},\n                    {key: modulename === null ? 'deletechecktype' : 'deletechecktypename', param: plugindata},\n                    {key: 'yes'},\n                    {key: 'no'}\n                ]).done(function(s) {\n                        notification.confirm(s[0], s[1], s[2], s[3], onconfirm);\n                    }\n                );\n            });\n        };\n\n        /**\n         * Displays the delete confirmation to delete a section\n         *\n         * @param {String} message confirmation message\n         * @param {function} onconfirm function to execute on confirm\n         */\n        var confirmEditSection = function(message, onconfirm) {\n            str.get_strings([\n                {key: 'confirm'}, // TODO link text\n                {key: 'yes'},\n                {key: 'no'}\n            ]).done(function(s) {\n                    notification.confirm(s[0], message, s[1], s[2], onconfirm);\n                }\n            );\n        };\n\n        /**\n         * Replaces an action menu item with another one (for example Show->Hide, Set marker->Remove marker)\n         *\n         * @param {JQuery} actionitem\n         * @param {String} image new image name (\"i/show\", \"i/hide\", etc.)\n         * @param {String} stringname new string for the action menu item\n         * @param {String} stringcomponent\n         * @param {String} newaction new value for data-action attribute of the link\n         * @return {Promise} promise which is resolved when the replacement has completed\n         */\n        var replaceActionItem = function(actionitem, image, stringname,\n                                           stringcomponent, newaction) {\n\n            var stringRequests = [{key: stringname, component: stringcomponent}];\n            // Do not provide an icon with duplicate, different text to the menu item.\n\n            return str.get_strings(stringRequests).then(function(strings) {\n                actionitem.find('span.menu-action-text').html(strings[0]);\n\n                return templates.renderPix(image, 'core');\n            }).then(function(pixhtml) {\n                actionitem.find('.icon').replaceWith(pixhtml);\n                actionitem.attr('data-action', newaction);\n                return;\n            }).catch(notification.exception);\n        };\n\n        /**\n         * Default post-processing for section AJAX edit actions.\n         *\n         * This can be overridden in course formats by listening to event coursesectionedited:\n         *\n         * $('body').on('coursesectionedited', 'li.section', function(e) {\n         *     var action = e.action,\n         *         sectionElement = $(e.target),\n         *         data = e.ajaxreturn;\n         *     // ... Do some processing here.\n         *     e.preventDefault(); // Prevent default handler.\n         * });\n         *\n         * @param {JQuery} sectionElement\n         * @param {JQuery} actionItem\n         * @param {Object} data\n         * @param {String} courseformat\n         * @param {Number} sectionid\n         */\n        var defaultEditSectionHandler = function(sectionElement, actionItem, data, courseformat, sectionid) {\n            var action = actionItem.attr('data-action');\n            if (action === 'hide' || action === 'show') {\n                if (action === 'hide') {\n                    sectionElement.addClass('hidden');\n                    setSectionBadge(sectionElement[0], 'hiddenfromstudents', true, false);\n                    replaceActionItem(actionItem, 'i/show',\n                        'showfromothers', 'format_' + courseformat, 'show');\n                } else {\n                    setSectionBadge(sectionElement[0], 'hiddenfromstudents', false, false);\n                    sectionElement.removeClass('hidden');\n                    replaceActionItem(actionItem, 'i/hide',\n                        'hidefromothers', 'format_' + courseformat, 'hide');\n                }\n                // Replace the modules with new html (that indicates that they are now hidden or not hidden).\n                if (data.modules !== undefined) {\n                    for (var i in data.modules) {\n                        replaceActivityHtmlWith(data.modules[i]);\n                    }\n                }\n                // Replace the section availability information.\n                if (data.section_availability !== undefined) {\n                    sectionElement.find('.section_availability').first().replaceWith(data.section_availability);\n                }\n                // Modify course state.\n                const section = courseeditor.state.section.get(sectionid);\n                if (section !== undefined) {\n                    courseeditor.dispatch('sectionState', [sectionid]);\n                }\n            } else if (action === 'setmarker') {\n                var oldmarker = $(SELECTOR.SECTIONLI + '.current'),\n                    oldActionItem = oldmarker.find(SELECTOR.SECTIONACTIONMENU + ' ' + 'a[data-action=removemarker]');\n                oldmarker.removeClass('current');\n                replaceActionItem(oldActionItem, 'i/marker',\n                    'highlight', 'core', 'setmarker');\n                sectionElement.addClass('current');\n                replaceActionItem(actionItem, 'i/marked',\n                    'highlightoff', 'core', 'removemarker');\n                courseeditor.dispatch('legacySectionAction', action, sectionid);\n                setSectionBadge(sectionElement[0], 'iscurrent', true, true);\n            } else if (action === 'removemarker') {\n                sectionElement.removeClass('current');\n                replaceActionItem(actionItem, 'i/marker',\n                    'highlight', 'core', 'setmarker');\n                courseeditor.dispatch('legacySectionAction', action, sectionid);\n                setSectionBadge(sectionElement[0], 'iscurrent', false, true);\n            }\n        };\n\n        /**\n         * Get the focused element path in an activity if any.\n         *\n         * This method is used to restore focus when the activity HTML is refreshed.\n         * Only the main course editor elements can be refocused as they are always present\n         * even if the activity content changes.\n         *\n         * @param {String} id the element id the activity element\n         * @return {String|undefined} the inner path of the focused element or undefined\n         */\n        const getActivityFocusedElement = function(id) {\n            const element = document.getElementById(id);\n            if (!element || !element.contains(document.activeElement)) {\n                return undefined;\n            }\n            // Check if the actions menu toggler is focused.\n            if (element.querySelector(SELECTOR.ACTIONAREA).contains(document.activeElement)) {\n                return `${SELECTOR.ACTIONAREA} [tabindex=\"0\"]`;\n            }\n            // Return the current element id if any.\n            if (document.activeElement.id) {\n                return `#${document.activeElement.id}`;\n            }\n            return undefined;\n        };\n\n        /**\n         * Replaces the course module with the new html (used to update module after it was edited or its visibility was changed).\n         *\n         * @param {String} activityHTML\n         */\n        var replaceActivityHtmlWith = function(activityHTML) {\n            $('<div>' + activityHTML + '</div>').find(SELECTOR.ACTIVITYLI).each(function() {\n                // Extract id from the new activity html.\n                var id = $(this).attr('id');\n                // Check if the current focused element is inside the activity.\n                let focusedPath = getActivityFocusedElement(id);\n                // Find the existing element with the same id and replace its contents with new html.\n                $(SELECTOR.ACTIVITYLI + '#' + id).replaceWith(activityHTML);\n                // Initialise action menu.\n                initActionMenu(id);\n                // Re-focus the previous elements.\n                if (focusedPath) {\n                    const newItem = document.getElementById(id);\n                    newItem.querySelector(focusedPath)?.focus();\n                }\n\n            });\n        };\n\n        /**\n         * Performs an action on a module (moving, deleting, duplicating, hiding, etc.)\n         *\n         * @param {JQuery} sectionElement section element we perform action on\n         * @param {Nunmber} sectionid\n         * @param {JQuery} target the element (menu item) that was clicked\n         * @param {String} courseformat\n         * @return {boolean} true the action call is sent to the server or false if it is ignored.\n         */\n        var editSection = function(sectionElement, sectionid, target, courseformat) {\n            var action = target.attr('data-action'),\n                sectionreturn = target.attr('data-sectionreturn') ? target.attr('data-sectionreturn') : 0;\n\n            // Filter direct component handled actions.\n            if (courseeditor.supportComponents && componentActions.includes(action)) {\n                return false;\n            }\n\n            var spinner = addSectionSpinner(sectionElement);\n            var promises = ajax.call([{\n                methodname: 'core_course_edit_section',\n                args: {id: sectionid, action: action, sectionreturn: sectionreturn}\n            }], true);\n\n            var lightbox = addSectionLightbox(sectionElement);\n            $.when.apply($, promises)\n                .done(function(dataencoded) {\n                    var data = $.parseJSON(dataencoded);\n                    removeSpinner(sectionElement, spinner);\n                    removeLightbox(lightbox);\n                    sectionElement.find(SELECTOR.SECTIONACTIONMENU).find(SELECTOR.TOGGLE).focus();\n                    // Trigger event that can be observed by course formats.\n                    var e = $.Event('coursesectionedited', {ajaxreturn: data, action: action});\n                    sectionElement.trigger(e);\n                    if (!e.isDefaultPrevented()) {\n                        defaultEditSectionHandler(sectionElement, target, data, courseformat, sectionid);\n                    }\n                }).fail(function(ex) {\n                    // Remove spinner and lightbox.\n                    removeSpinner(sectionElement, spinner);\n                    removeLightbox(lightbox);\n                    // Trigger event that can be observed by course formats.\n                    var e = $.Event('coursesectioneditfailed', {exception: ex, action: action});\n                    sectionElement.trigger(e);\n                    if (!e.isDefaultPrevented()) {\n                        notification.exception(ex);\n                    }\n                });\n            return true;\n        };\n\n        /**\n         * Sets the section badge in the section header.\n         *\n         * @param {JQuery} sectionElement section element we perform action on\n         * @param {String} badgetype the type of badge this is for\n         * @param {bool} add true to add, false to remove\n         * @param {boolean} removeOther in case of adding a badge, whether to remove all other.\n         */\n        var setSectionBadge = function(sectionElement, badgetype, add, removeOther) {\n            const sectionbadges = sectionElement.querySelector(SELECTOR.SECTIONBADGES);\n            if (!sectionbadges) {\n                return;\n            }\n            const badge = sectionbadges.querySelector('[data-type=\"' + badgetype + '\"]');\n            if (!badge) {\n                return;\n            }\n            if (add) {\n                if (removeOther) {\n                    document.querySelectorAll('[data-type=\"' + badgetype + '\"]').forEach((b) => {\n                        b.classList.add('d-none');\n                    });\n                }\n                badge.classList.remove('d-none');\n            } else {\n                badge.classList.add('d-none');\n            }\n        };\n\n        // Register a function to be executed after D&D of an activity.\n        Y.use('moodle-course-coursebase', function() {\n            M.course.coursebase.register_module({\n                // Ignore camelcase eslint rule for the next line because it is an expected name of the callback.\n                // eslint-disable-next-line camelcase\n                set_visibility_resource_ui: function(args) {\n                    var mainelement = $(args.element.getDOMNode());\n                    var cmid = getModuleId(mainelement);\n                    if (cmid) {\n                        var sectionreturn = mainelement.find('.' + CSS.EDITINGMOVE).attr('data-sectionreturn');\n                        refreshModule(mainelement, cmid, sectionreturn);\n                    }\n                },\n                /**\n                 * Update the course state when some cm is moved via YUI.\n                 * @param {*} params\n                 */\n                updateMovedCmState: (params) => {\n                    const state = courseeditor.state;\n\n                    // Update old section.\n                    const cm = state.cm.get(params.cmid);\n                    if (cm !== undefined) {\n                        courseeditor.dispatch('sectionState', [cm.sectionid]);\n                    }\n                    // Update cm state.\n                    courseeditor.dispatch('cmState', [params.cmid]);\n                },\n                /**\n                 * Update the course state when some section is moved via YUI.\n                 */\n                updateMovedSectionState: () => {\n                    courseeditor.dispatch('courseState');\n                },\n            });\n        });\n\n        // From Moodle 4.0 all edit actions are being re-implemented as state mutation.\n        // This means all method from this \"actions\" module will be deprecated when all the course\n        // interface is migrated to reactive components.\n        // Most legacy actions did not provide enough information to regenarate the course so they\n        // use the mutations courseState, sectionState and cmState to get the updated state from\n        // the server. However, some activity actions where we can prevent an extra webservice\n        // call by implementing an adhoc mutation.\n        courseeditor.addMutations({\n            /**\n             * Compatibility function to update Moodle 4.0 course state using legacy actions.\n             *\n             * This method only updates some actions which does not require to use cmState mutation\n             * to get updated data form the server.\n             *\n             * @param {Object} statemanager the current state in read write mode\n             * @param {String} action the performed action\n             * @param {Number} cmid the affected course module id\n             * @param {Array} affectedids all affected cm ids (for duplicate action)\n             */\n            legacyActivityAction: function(statemanager, action, cmid, affectedids) {\n\n                const state = statemanager.state;\n                const cm = state.cm.get(cmid);\n                if (cm === undefined) {\n                    return;\n                }\n                const section = state.section.get(cm.sectionid);\n                if (section === undefined) {\n                    return;\n                }\n\n                // Send the element is locked.\n                courseeditor.dispatch('cmLock', [cm.id], true);\n\n                // Now we do the real mutation.\n                statemanager.setReadOnly(false);\n\n                // This unlocked will take effect when the read only is restored.\n                cm.locked = false;\n\n                switch (action) {\n                    case 'delete':\n                        // Remove from section.\n                        section.cmlist = section.cmlist.reduce(\n                            (cmlist, current) => {\n                                if (current != cmid) {\n                                    cmlist.push(current);\n                                }\n                                return cmlist;\n                            },\n                            []\n                        );\n                        // Delete form list.\n                        state.cm.delete(cmid);\n                        break;\n\n                    case 'hide':\n                    case 'show':\n                    case 'duplicate':\n                        courseeditor.dispatch('cmState', affectedids);\n                        break;\n                }\n                statemanager.setReadOnly(true);\n            },\n            legacySectionAction: function(statemanager, action, sectionid) {\n\n                const state = statemanager.state;\n                const section = state.section.get(sectionid);\n                if (section === undefined) {\n                    return;\n                }\n\n                // Send the element is locked. Reactive events are only triggered when the state\n                // read only mode is restored. We want to notify the interface the element is\n                // locked so we need to do a quick lock operation before performing the rest\n                // of the mutation.\n                statemanager.setReadOnly(false);\n                section.locked = true;\n                statemanager.setReadOnly(true);\n\n                // Now we do the real mutation.\n                statemanager.setReadOnly(false);\n\n                // This locked will take effect when the read only is restored.\n                section.locked = false;\n\n                switch (action) {\n                    case 'setmarker':\n                        // Remove previous marker.\n                        state.section.forEach((current) => {\n                            if (current.id != sectionid) {\n                                current.current = false;\n                            }\n                        });\n                        section.current = true;\n                        break;\n\n                    case 'removemarker':\n                        section.current = false;\n                        break;\n                }\n                statemanager.setReadOnly(true);\n            },\n        });\n\n        return /** @alias module:core_course/actions */ {\n\n            /**\n             * Initialises course page\n             *\n             * @method init\n             * @param {String} courseformat name of the current course format (for fetching strings)\n             */\n            initCoursePage: function(courseformat) {\n\n                formatname = courseformat;\n\n                // Add a handler for course module actions.\n                $('body').on('click keypress', SELECTOR.ACTIVITYLI + ' ' +\n                        SELECTOR.ACTIVITYACTION + '[data-action]', function(e) {\n                    if (e.type === 'keypress' && e.keyCode !== 13) {\n                        return;\n                    }\n                    var actionItem = $(this),\n                        moduleElement = actionItem.closest(SELECTOR.ACTIVITYLI),\n                        action = actionItem.attr('data-action'),\n                        moduleId = getModuleId(moduleElement);\n                    switch (action) {\n                        case 'moveleft':\n                        case 'moveright':\n                        case 'delete':\n                        case 'duplicate':\n                        case 'hide':\n                        case 'stealth':\n                        case 'show':\n                        case 'groupsseparate':\n                        case 'groupsvisible':\n                        case 'groupsnone':\n                            break;\n                        default:\n                            // Nothing to do here!\n                            return;\n                    }\n                    if (!moduleId) {\n                        return;\n                    }\n                    e.preventDefault();\n                    if (action === 'delete') {\n                        // Deleting requires confirmation.\n                        confirmDeleteModule(moduleElement, function() {\n                            editModule(moduleElement, moduleId, actionItem);\n                        });\n                    } else {\n                        editModule(moduleElement, moduleId, actionItem);\n                    }\n                });\n\n                // Add a handler for section show/hide actions.\n                $('body').on('click keypress', SELECTOR.SECTIONLI + ' ' +\n                            SELECTOR.SECTIONACTIONMENU + '[data-sectionid] ' +\n                            'a[data-action]', function(e) {\n                    if (e.type === 'keypress' && e.keyCode !== 13) {\n                        return;\n                    }\n                    var actionItem = $(this),\n                        sectionElement = actionItem.closest(SELECTOR.SECTIONLI),\n                        sectionId = actionItem.closest(SELECTOR.SECTIONACTIONMENU).attr('data-sectionid');\n\n                    let isExecuted = true;\n                    if (actionItem.attr('data-confirm')) {\n                        // Action requires confirmation.\n                        confirmEditSection(actionItem.attr('data-confirm'), function() {\n                            isExecuted = editSection(sectionElement, sectionId, actionItem, courseformat);\n                        });\n                    } else {\n                        isExecuted = editSection(sectionElement, sectionId, actionItem, courseformat);\n                    }\n                    // Prevent any other module from capturing the action if it is already in execution.\n                    if (isExecuted) {\n                        e.preventDefault();\n                    }\n                });\n\n                // The section and activity names are edited using inplace editable.\n                // The \"update\" jQuery event must be captured in order to update the course state.\n                $('body').on('updated', `${SELECTOR.SECTIONLI} [data-inplaceeditable]`, function(e) {\n                    if (e.ajaxreturn && e.ajaxreturn.itemid) {\n                        const state = courseeditor.state;\n                        const section = state.section.get(e.ajaxreturn.itemid);\n                        if (section !== undefined) {\n                            courseeditor.dispatch('sectionState', [e.ajaxreturn.itemid]);\n                        }\n                    }\n                });\n                $('body').on('updated', `${SELECTOR.ACTIVITYLI} [data-inplaceeditable]`, function(e) {\n                    if (e.ajaxreturn && e.ajaxreturn.itemid) {\n                        courseeditor.dispatch('cmState', [e.ajaxreturn.itemid]);\n                    }\n                });\n\n                // Component-based formats don't use modals to create sections.\n                if (courseeditor.supportComponents && componentActions.includes('addSection')) {\n                    return;\n                }\n\n                // Add a handler for \"Add sections\" link to ask for a number of sections to add.\n                str.get_string('numberweeks').done(function(strNumberSections) {\n                    var trigger = $(SELECTOR.ADDSECTIONS),\n                        modalTitle = trigger.attr('data-add-sections'),\n                        newSections = trigger.attr('data-new-sections');\n                    var modalBody = $('<div><label for=\"add_section_numsections\"></label> ' +\n                        '<input id=\"add_section_numsections\" type=\"number\" min=\"1\" max=\"' + newSections + '\" value=\"1\"></div>');\n                    modalBody.find('label').html(strNumberSections);\n                    ModalFactory.create({\n                        title: modalTitle,\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        body: modalBody.html()\n                    }, trigger)\n                    .done(function(modal) {\n                        var numSections = $(modal.getBody()).find('#add_section_numsections'),\n                        addSections = function() {\n                            // Check if value of the \"Number of sections\" is a valid positive integer and redirect\n                            // to adding a section script.\n                            if ('' + parseInt(numSections.val()) === numSections.val() && parseInt(numSections.val()) >= 1) {\n                                document.location = trigger.attr('href') + '&numsections=' + parseInt(numSections.val());\n                            }\n                        };\n                        modal.setSaveButtonText(modalTitle);\n                        modal.getRoot().on(ModalEvents.shown, function() {\n                            // When modal is shown focus and select the input and add a listener to keypress of \"Enter\".\n                            numSections.focus().select().on('keydown', function(e) {\n                                if (e.keyCode === KeyCodes.enter) {\n                                    addSections();\n                                }\n                            });\n                        });\n                        modal.getRoot().on(ModalEvents.save, function(e) {\n                            // When modal \"Add\" button is pressed.\n                            e.preventDefault();\n                            addSections();\n                        });\n                    });\n                });\n            },\n\n            /**\n             * Replaces a section action menu item with another one (for example Show->Hide, Set marker->Remove marker)\n             *\n             * This method can be used by course formats in their listener to the coursesectionedited event\n             *\n             * @deprecated since Moodle 3.9\n             * @param {JQuery} sectionelement\n             * @param {String} selector CSS selector inside the section element, for example \"a[data-action=show]\"\n             * @param {String} image new image name (\"i/show\", \"i/hide\", etc.)\n             * @param {String} stringname new string for the action menu item\n             * @param {String} stringcomponent\n             * @param {String} newaction new value for data-action attribute of the link\n             */\n            replaceSectionActionItem: function(sectionelement, selector, image, stringname,\n                                                    stringcomponent, newaction) {\n                log.debug('replaceSectionActionItem() is deprecated and will be removed.');\n                var actionitem = sectionelement.find(SELECTOR.SECTIONACTIONMENU + ' ' + selector);\n                replaceActionItem(actionitem, image, stringname, stringcomponent, newaction);\n            },\n            // Method to refresh a module.\n            refreshModule,\n            refreshSection,\n        };\n    });\n"],"names":["define","$","ajax","templates","notification","str","url","Y","ModalFactory","ModalEvents","KeyCodes","log","editor","EventDispatcher","CourseEvents","formatname","componentActions","courseeditor","getCurrentCourseEditor","CSS","SELECTOR","ACTIVITYLI","ACTIONAREA","ACTIVITYACTION","MENU","TOGGLE","SECTIONLI","SECTIONACTIONMENU","ADDSECTIONS","SECTIONBADGES","use","courseformatselector","M","course","format","get_section_selector","dispatchEvent","eventName","detail","container","options","Element","undefined","get","getModuleId","element","id","item","dataset","Moodle","core_course","util","cm","getId","Node","addActivitySpinner","activity","addClass","actionarea","find","spinner","add_spinner","show","data","dispatch","addSectionSpinner","sectionelement","addSectionLightbox","lightbox","add_lightbox","for","setAttribute","removeSpinner","delay","window","setTimeout","removeClass","hide","mutation","removeLightbox","getAttribute","initActionMenu","elementid","coursebase","invoke_function","core","actionmenu","newDOMNode","one","editModule","moduleElement","cmid","target","action","attr","promises","call","methodname","args","sectionreturn","closest","when","apply","done","mainElement","tabables","isInside","foundElement","elementToFocus","each","contains","this","replaceWith","affectedids","index","elementId","mainelement","selector","is","focus","focusActionItem","push","trigger","Event","ajaxreturn","fail","ex","e","exception","isDefaultPrevented","refreshModule","sectionReturn","activityElement","Promise","resolve","reject","replaceActivityHtmlWith","confirmDeleteModule","onconfirm","modtypename","match","modulename","name","getName","_state$cm$get","state","getModuleName","get_string","pluginname","plugindata","type","get_strings","key","component","param","s","confirm","replaceActionItem","actionitem","image","stringname","stringcomponent","newaction","stringRequests","then","strings","html","renderPix","pixhtml","catch","defaultEditSectionHandler","sectionElement","actionItem","courseformat","sectionid","setSectionBadge","modules","i","section_availability","first","section","oldmarker","oldActionItem","activityHTML","_newItem$querySelecto","focusedPath","document","getElementById","activeElement","querySelector","concat","getActivityFocusedElement","newItem","editSection","supportComponents","includes","dataencoded","parseJSON","badgetype","add","removeOther","sectionbadges","badge","querySelectorAll","forEach","b","classList","remove","register_module","set_visibility_resource_ui","getDOMNode","updateMovedCmState","params","updateMovedSectionState","addMutations","legacyActivityAction","statemanager","setReadOnly","locked","cmlist","reduce","current","delete","legacySectionAction","initCoursePage","on","keyCode","moduleId","preventDefault","message","sectionId","isExecuted","itemid","strNumberSections","modalTitle","newSections","modalBody","create","title","types","SAVE_CANCEL","body","modal","numSections","getBody","addSections","parseInt","val","location","setSaveButtonText","getRoot","shown","select","enter","save","replaceSectionActionItem","debug","refreshSection","newSectionElement","content","sectionRefreshed","defaultPrevented"],"mappings":"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"}