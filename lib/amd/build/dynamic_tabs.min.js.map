{"version":3,"file":"dynamic_tabs.min.js","sources":["../src/dynamic_tabs.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Dynamic Tabs UI element with AJAX loading of tabs content\n *\n * @module      core/dynamic_tabs\n * @copyright   2021 David Matamoros <davidmc@moodle.com> based on code from Marina Glancy\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Templates from 'core/templates';\nimport {addIconToContainer} from 'core/loadingicon';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport {get_strings as getStrings} from 'core/str';\nimport {getContent} from 'core/local/repository/dynamic_tabs';\nimport {isAnyWatchedFormDirty, resetAllFormDirtyStates} from 'core_form/changechecker';\n\nconst SELECTORS = {\n    dynamicTabs: '.dynamictabs',\n    activeTab: '.dynamictabs .nav-link.active',\n    allActiveTabs: '.dynamictabs .nav-link[data-toggle=\"tab\"]:not(.disabled)',\n    tabContent: '.dynamictabs .tab-pane [data-tab-content]',\n    tabToggle: 'a[data-toggle=\"tab\"]',\n    tabPane: '.dynamictabs .tab-pane',\n};\n\nSELECTORS.forTabName = tabName => `.dynamictabs [data-tab-content=\"${tabName}\"]`;\nSELECTORS.forTabId = tabName => `.dynamictabs [data-toggle=\"tab\"][href=\"#${tabName}\"]`;\n\n/**\n * Initialises the tabs view on the page (only one tabs view per page is supported)\n */\nexport const init = () => {\n    const tabToggle = $(SELECTORS.tabToggle);\n\n    // Listen to click, warn user if they are navigating away with unsaved form changes.\n    tabToggle.on('click', (event) => {\n        if (!isAnyWatchedFormDirty()) {\n            return;\n        }\n\n        event.preventDefault();\n        event.stopPropagation();\n\n        getStrings([\n            {key: 'changesmade', component: 'moodle'},\n            {key: 'changesmadereallygoaway', component: 'moodle'},\n            {key: 'confirm', component: 'moodle'},\n        ]).then(([strChangesMade, strChangesMadeReally, strConfirm]) =>\n            // Reset form dirty state on confirmation, re-trigger the event.\n            Notification.confirm(strChangesMade, strChangesMadeReally, strConfirm, null, () => {\n                resetAllFormDirtyStates();\n                $(event.target).trigger(event.type);\n            })\n        ).catch(Notification.exception);\n    });\n\n    // This code listens to Bootstrap events 'show.bs.tab' and 'shown.bs.tab' which is triggered using JQuery and\n    // can not be converted yet to native events.\n    tabToggle\n        .on('show.bs.tab', function() {\n            // Clean content from previous tab.\n            const previousTabName = getActiveTabName();\n            if (previousTabName) {\n                const previousTab = document.querySelector(SELECTORS.forTabName(previousTabName));\n                previousTab.textContent = '';\n            }\n        })\n        .on('shown.bs.tab', function() {\n            const tab = $($(this).attr('href'));\n            if (tab.length !== 1) {\n                return;\n            }\n            loadTab(tab.attr('id'));\n        });\n\n    if (!openTabFromHash()) {\n        const tabs = document.querySelector(SELECTORS.allActiveTabs);\n        if (tabs) {\n            openTab(tabs.getAttribute('aria-controls'));\n        } else {\n            // We may hide tabs if there is only one available, just load the contents of the first tab.\n            const tabPane = document.querySelector(SELECTORS.tabPane);\n            if (tabPane) {\n                tabPane.classList.add('active', 'show');\n                loadTab(tabPane.getAttribute('id'));\n            }\n        }\n    }\n};\n\n/**\n * Returns id/name of the currently active tab\n *\n * @return {String|null}\n */\nconst getActiveTabName = () => {\n    const element = document.querySelector(SELECTORS.activeTab);\n    return element?.getAttribute('aria-controls') || null;\n};\n\n/**\n * Returns the id/name of the first tab\n *\n * @return {String|null}\n */\nconst getFirstTabName = () => {\n    const element = document.querySelector(SELECTORS.tabContent);\n    return element?.dataset.tabContent || null;\n};\n\n/**\n * Loads contents of a tab using an AJAX request\n *\n * @param {String} tabName\n */\nconst loadTab = (tabName) => {\n    // If tabName is not specified find the active tab, or if is not defined, the first available tab.\n    tabName = tabName ?? getActiveTabName() ?? getFirstTabName();\n    const tab = document.querySelector(SELECTORS.forTabName(tabName));\n    if (!tab) {\n        return;\n    }\n\n    const pendingPromise = new Pending('core/dynamic_tabs:loadTab:' + tabName);\n    let tabjs = '';\n\n    addIconToContainer(tab)\n    .then(() => {\n        let tabArgs = {...tab.dataset};\n        delete tabArgs.tabClass;\n        delete tabArgs.tabContent;\n        return getContent(tab.dataset.tabClass, JSON.stringify(tabArgs));\n    })\n    .then((data) => {\n        tabjs = data.javascript;\n        return Templates.render(data.template, JSON.parse(data.content));\n    })\n    .then((html, js) => {\n        return Templates.replaceNodeContents(tab, html, js + tabjs);\n    })\n    .then(() => {\n        pendingPromise.resolve();\n        return null;\n    })\n    .catch(Notification.exception);\n};\n\n/**\n * Return the tab given the tab name\n *\n * @param {String} tabName\n * @return {HTMLElement}\n */\nconst getTab = (tabName) => {\n    return document.querySelector(SELECTORS.forTabId(tabName));\n};\n\n/**\n * Return the tab pane given the tab name\n *\n * @param {String} tabName\n * @return {HTMLElement}\n */\nconst getTabPane = (tabName) => {\n    return document.getElementById(tabName);\n};\n\n/**\n * Open the tab on page load. If this script loads before theme_boost/tab we need to open tab ourselves\n *\n * @param {String} tabName\n * @return {Boolean}\n */\nconst openTab = (tabName) => {\n    const tab = getTab(tabName);\n    if (!tab) {\n        return false;\n    }\n\n    loadTab(tabName);\n    tab.classList.add('active');\n    getTabPane(tabName).classList.add('active', 'show');\n    return true;\n};\n\n/**\n * If there is a location hash that is the same as the tab name - open this tab.\n *\n * @return {Boolean}\n */\nconst openTabFromHash = () => {\n    const hash = document.location.hash;\n    if (hash.match(/^#\\w+$/g)) {\n        return openTab(hash.replace(/^#/g, ''));\n    }\n\n    return false;\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_defineProperty","key","value","arg","input","hint","_typeof","prim","Symbol","toPrimitive","undefined","res","call","TypeError","String","Number","_toPrimitive","_toPropertyKey","defineProperty","configurable","writable","_slicedToArray","arr","i","Array","isArray","_arrayWithHoles","_i","iterator","_s","_e","_x","_r","_arr","_n","_d","next","done","length","err","return","_iterableToArrayLimit","o","minLen","_arrayLikeToArray","n","prototype","toString","slice","constructor","name","from","test","_unsupportedIterableToArray","_nonIterableRest","len","arr2","_jquery","_templates","_notification","_pending","SELECTORS","dynamicTabs","activeTab","allActiveTabs","tabContent","tabToggle","tabPane","tabName","concat","_exports","init","$","on","event","isAnyWatchedFormDirty","preventDefault","stopPropagation","getStrings","component","then","_ref","_ref2","strChangesMade","strChangesMadeReally","strConfirm","Notification","confirm","resetAllFormDirtyStates","target","trigger","type","catch","exception","previousTabName","getActiveTabName","document","querySelector","forTabName","textContent","tab","this","attr","loadTab","openTabFromHash","tabs","openTab","getAttribute","classList","add","element","_ref3","_tabName","dataset","pendingPromise","Pending","tabjs","addIconToContainer","tabArgs","arguments","source","forEach","getOwnPropertyDescriptors","defineProperties","_objectSpread","tabClass","getContent","JSON","stringify","data","javascript","Templates","render","template","parse","content","html","js","replaceNodeContents","resolve","forTabId","getTab","getElementById","getTabPane","hash","location","match","replace"],"mappings":"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"}