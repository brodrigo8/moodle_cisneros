{"version":3,"file":"downloadcontent.min.js","sources":["../src/downloadcontent.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Functions related to downloading course content.\n *\n * @module     core_course/downloadcontent\n * @copyright  2020 Michael Hawkins <michaelh@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Config from 'core/config';\nimport CustomEvents from 'core/custom_interaction_events';\nimport * as ModalFactory from 'core/modal_factory';\nimport jQuery from 'jquery';\nimport Pending from 'core/pending';\nimport {enter, space} from 'core/key_codes';\n\n/**\n * Set up listener to trigger the download course content modal.\n *\n * @return {void}\n */\nexport const init = () => {\n    const pendingPromise = new Pending();\n\n    // Add event listeners for click and enter/space keys.\n    jQuery('[data-downloadcourse]').on('click keydown', (e) => {\n        if (e.type === 'click' || e.which === enter || e.which === space) {\n            e.preventDefault();\n            displayDownloadConfirmation(e.currentTarget);\n        }\n    });\n\n    pendingPromise.resolve();\n};\n\n/**\n * Display the download course content modal.\n *\n * @method displayDownloadConfirmation\n * @param {Object} downloadModalTrigger The DOM element that triggered the download modal.\n * @return {void}\n */\nconst displayDownloadConfirmation = (downloadModalTrigger) => {\n    ModalFactory.create({\n        title: downloadModalTrigger.dataset.downloadTitle,\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: `<p>${downloadModalTrigger.dataset.downloadBody}</p>`,\n        buttons: {\n            save: downloadModalTrigger.dataset.downloadButtonText\n        },\n        templateContext: {\n            classes: 'downloadcoursecontentmodal'\n        }\n    })\n    .then(modal => {\n        // Display the modal.\n        modal.show();\n\n        const saveButton = document.querySelector('.modal .downloadcoursecontentmodal [data-action=\"save\"]');\n        const cancelButton = document.querySelector('.modal .downloadcoursecontentmodal [data-action=\"cancel\"]');\n        const modalContainer = document.querySelector('.modal[data-region=\"modal-container\"]');\n\n        // Create listener to trigger the download when the \"Download\" button is pressed.\n        jQuery(saveButton).on(CustomEvents.events.activate, (e) => downloadContent(e, downloadModalTrigger, modal));\n\n        // Create listener to destroy the modal when closing modal by cancelling.\n        jQuery(cancelButton).on(CustomEvents.events.activate, () => {\n            modal.destroy();\n        });\n\n        // Create listener to destroy the modal when closing modal by clicking outside of it.\n        if (modalContainer.querySelector('.downloadcoursecontentmodal')) {\n            jQuery(modalContainer).on(CustomEvents.events.activate, () => {\n                modal.destroy();\n            });\n        }\n    });\n};\n\n/**\n * Trigger downloading of course content.\n *\n * @method downloadContent\n * @param {Event} e The event triggering the download.\n * @param {Object} downloadModalTrigger The DOM element that triggered the download modal.\n * @param {Object} modal The modal object.\n * @return {void}\n */\nconst downloadContent = (e, downloadModalTrigger, modal) => {\n    e.preventDefault();\n\n    // Create a form to submit the file download request, so we can avoid sending sesskey over GET.\n    const downloadForm = document.createElement('form');\n    downloadForm.action = downloadModalTrigger.dataset.downloadLink;\n    downloadForm.method = 'POST';\n    // Open download in a new tab, so current course view is not disrupted.\n    downloadForm.target = '_blank';\n    const downloadSesskey = document.createElement('input');\n    downloadSesskey.name = 'sesskey';\n    downloadSesskey.value = Config.sesskey;\n    downloadForm.appendChild(downloadSesskey);\n    downloadForm.style.display = 'none';\n\n    document.body.appendChild(downloadForm);\n    downloadForm.submit();\n    document.body.removeChild(downloadForm);\n\n    // Destroy the modal to prevent duplicates if reopened later.\n    modal.destroy();\n};\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireDefault","obj","__esModule","default","_config","_custom_interaction_events","ModalFactory","_typeof","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_jquery","_pending","_exports","init","pendingPromise","Pending","jQuery","on","e","type","which","enter","space","preventDefault","displayDownloadConfirmation","currentTarget","resolve","downloadModalTrigger","create","title","dataset","downloadTitle","types","SAVE_CANCEL","body","downloadBody","buttons","save","downloadButtonText","templateContext","classes","then","modal","show","saveButton","document","querySelector","cancelButton","modalContainer","CustomEvents","events","activate","downloadContent","destroy","downloadForm","createElement","action","downloadLink","method","target","downloadSesskey","name","value","Config","sesskey","appendChild","style","display","submit","removeChild"],"mappings":"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"}