{"version":3,"file":"tour.min.js","sources":["../src/tour.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A user tour.\n *\n * @module tool_usertours/tour\n * @copyright  2018 Andrew Nicols <andrew@nicols.co.uk>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * A list of steps.\n *\n * @typedef {Object[]} StepList\n * @property {Number} stepId The id of the step in the database\n * @property {Number} position The position of the step within the tour (zero-indexed)\n */\n\nimport $ from 'jquery';\nimport * as Aria from 'core/aria';\nimport Popper from 'core/popper';\nimport {dispatchEvent} from 'core/event_dispatcher';\nimport {eventTypes} from './events';\nimport {get_string as getString} from 'core/str';\nimport {prefetchStrings} from 'core/prefetch';\n\n/**\n * The minimum spacing for tour step to display.\n *\n * @private\n * @constant\n * @type {number}\n */\nconst MINSPACING = 10;\n\n/**\n * A user tour.\n *\n * @class tool_usertours/tour\n * @property {boolean} tourRunning Whether the tour is currently running.\n */\nconst Tour = class {\n    tourRunning = false;\n\n    /**\n     * @param   {object}    config  The configuration object.\n     */\n    constructor(config) {\n        this.init(config);\n    }\n\n    /**\n     * Initialise the tour.\n     *\n     * @method  init\n     * @param   {Object}    config  The configuration object.\n     * @chainable\n     * @return {Object} this.\n     */\n    init(config) {\n        // Unset all handlers.\n        this.eventHandlers = {};\n\n        // Reset the current tour states.\n        this.reset();\n\n        // Store the initial configuration.\n        this.originalConfiguration = config || {};\n\n        // Apply configuration.\n        this.configure.apply(this, arguments);\n\n        // Unset recalculate state.\n        this.possitionNeedToBeRecalculated = false;\n\n        // Unset recalculate count.\n        this.recalculatedNo = 0;\n\n        try {\n            this.storage = window.sessionStorage;\n            this.storageKey = 'tourstate_' + this.tourName;\n        } catch (e) {\n            this.storage = false;\n            this.storageKey = '';\n        }\n\n        prefetchStrings('tool_usertours', [\n            'nextstep_sequence',\n            'skip_tour'\n        ]);\n\n        return this;\n    }\n\n    /**\n     * Reset the current tour state.\n     *\n     * @method  reset\n     * @chainable\n     * @return {Object} this.\n     */\n    reset() {\n        // Hide the current step.\n        this.hide();\n\n        // Unset all handlers.\n        this.eventHandlers = [];\n\n        // Unset all listeners.\n        this.resetStepListeners();\n\n        // Unset the original configuration.\n        this.originalConfiguration = {};\n\n        // Reset the current step number and list of steps.\n        this.steps = [];\n\n        // Reset the current step number.\n        this.currentStepNumber = 0;\n\n        return this;\n    }\n\n    /**\n     * Prepare tour configuration.\n     *\n     * @method  configure\n     * @param {Object} config The configuration object.\n     * @chainable\n     * @return {Object} this.\n     */\n    configure(config) {\n        if (typeof config === 'object') {\n            // Tour name.\n            if (typeof config.tourName !== 'undefined') {\n                this.tourName = config.tourName;\n            }\n\n            // Set up eventHandlers.\n            if (config.eventHandlers) {\n                for (let eventName in config.eventHandlers) {\n                    config.eventHandlers[eventName].forEach(function(handler) {\n                        this.addEventHandler(eventName, handler);\n                    }, this);\n                }\n            }\n\n            // Reset the step configuration.\n            this.resetStepDefaults(true);\n\n            // Configure the steps.\n            if (typeof config.steps === 'object') {\n                this.steps = config.steps;\n            }\n\n            if (typeof config.template !== 'undefined') {\n                this.templateContent = config.template;\n            }\n        }\n\n        // Check that we have enough to start the tour.\n        this.checkMinimumRequirements();\n\n        return this;\n    }\n\n    /**\n     * Check that the configuration meets the minimum requirements.\n     *\n     * @method  checkMinimumRequirements\n     */\n    checkMinimumRequirements() {\n        // Need a tourName.\n        if (!this.tourName) {\n            throw new Error(\"Tour Name required\");\n        }\n\n        // Need a minimum of one step.\n        if (!this.steps || !this.steps.length) {\n            throw new Error(\"Steps must be specified\");\n        }\n    }\n\n    /**\n     * Reset step default configuration.\n     *\n     * @method  resetStepDefaults\n     * @param   {Boolean}   loadOriginalConfiguration   Whether to load the original configuration supplied with the Tour.\n     * @chainable\n     * @return {Object} this.\n     */\n    resetStepDefaults(loadOriginalConfiguration) {\n        if (typeof loadOriginalConfiguration === 'undefined') {\n            loadOriginalConfiguration = true;\n        }\n\n        this.stepDefaults = {};\n        if (!loadOriginalConfiguration || typeof this.originalConfiguration.stepDefaults === 'undefined') {\n            this.setStepDefaults({});\n        } else {\n            this.setStepDefaults(this.originalConfiguration.stepDefaults);\n        }\n\n        return this;\n    }\n\n    /**\n     * Set the step defaults.\n     *\n     * @method  setStepDefaults\n     * @param   {Object}    stepDefaults                The step defaults to apply to all steps\n     * @chainable\n     * @return {Object} this.\n     */\n    setStepDefaults(stepDefaults) {\n        if (!this.stepDefaults) {\n            this.stepDefaults = {};\n        }\n        $.extend(\n            this.stepDefaults,\n            {\n                element:        '',\n                placement:      'top',\n                delay:          0,\n                moveOnClick:    false,\n                moveAfterTime:  0,\n                orphan:         false,\n                direction:      1,\n            },\n            stepDefaults\n        );\n\n        return this;\n    }\n\n    /**\n     * Retrieve the current step number.\n     *\n     * @method  getCurrentStepNumber\n     * @return  {Number}                   The current step number\n     */\n    getCurrentStepNumber() {\n        return parseInt(this.currentStepNumber, 10);\n    }\n\n    /**\n     * Store the current step number.\n     *\n     * @method  setCurrentStepNumber\n     * @param   {Number}   stepNumber      The current step number\n     * @chainable\n     */\n    setCurrentStepNumber(stepNumber) {\n        this.currentStepNumber = stepNumber;\n        if (this.storage) {\n            try {\n                this.storage.setItem(this.storageKey, stepNumber);\n            } catch (e) {\n                if (e.code === DOMException.QUOTA_EXCEEDED_ERR) {\n                    this.storage.removeItem(this.storageKey);\n                }\n            }\n        }\n    }\n\n    /**\n     * Get the next step number after the currently displayed step.\n     *\n     * @method  getNextStepNumber\n     * @param   {Number}   stepNumber      The current step number\n     * @return  {Number}    The next step number to display\n     */\n    getNextStepNumber(stepNumber) {\n        if (typeof stepNumber === 'undefined') {\n            stepNumber = this.getCurrentStepNumber();\n        }\n        let nextStepNumber = stepNumber + 1;\n\n        // Keep checking the remaining steps.\n        while (nextStepNumber <= this.steps.length) {\n            if (this.isStepPotentiallyVisible(this.getStepConfig(nextStepNumber))) {\n                return nextStepNumber;\n            }\n            nextStepNumber++;\n        }\n\n        return null;\n    }\n\n    /**\n     * Get the previous step number before the currently displayed step.\n     *\n     * @method  getPreviousStepNumber\n     * @param   {Number}   stepNumber      The current step number\n     * @return  {Number}    The previous step number to display\n     */\n    getPreviousStepNumber(stepNumber) {\n        if (typeof stepNumber === 'undefined') {\n            stepNumber = this.getCurrentStepNumber();\n        }\n        let previousStepNumber = stepNumber - 1;\n\n        // Keep checking the remaining steps.\n        while (previousStepNumber >= 0) {\n            if (this.isStepPotentiallyVisible(this.getStepConfig(previousStepNumber))) {\n                return previousStepNumber;\n            }\n            previousStepNumber--;\n        }\n\n        return null;\n    }\n\n    /**\n     * Is the step the final step number?\n     *\n     * @method  isLastStep\n     * @param   {Number}   stepNumber  Step number to test\n     * @return  {Boolean}               Whether the step is the final step\n     */\n    isLastStep(stepNumber) {\n        let nextStepNumber = this.getNextStepNumber(stepNumber);\n\n        return nextStepNumber === null;\n    }\n\n    /**\n     * Is this step potentially visible?\n     *\n     * @method  isStepPotentiallyVisible\n     * @param   {Object}    stepConfig      The step configuration to normalise\n     * @return  {Boolean}               Whether the step is the potentially visible\n     */\n    isStepPotentiallyVisible(stepConfig) {\n        if (!stepConfig) {\n            // Without step config, there can be no step.\n            return false;\n        }\n\n        if (this.isStepActuallyVisible(stepConfig)) {\n            // If it is actually visible, it is already potentially visible.\n            return true;\n        }\n\n        if (typeof stepConfig.orphan !== 'undefined' && stepConfig.orphan) {\n            // Orphan steps have no target. They are always visible.\n            return true;\n        }\n\n        if (typeof stepConfig.delay !== 'undefined' && stepConfig.delay) {\n            // Only return true if the activated has not been used yet.\n            return true;\n        }\n\n        // Not theoretically, or actually visible.\n        return false;\n    }\n\n    /**\n     * Get potentially visible steps in a tour.\n     *\n     * @returns {StepList} A list of ordered steps\n     */\n    getPotentiallyVisibleSteps() {\n        let position = 1;\n        let result = [];\n        // Checking the total steps.\n        for (let stepNumber = 0; stepNumber < this.steps.length; stepNumber++) {\n            const stepConfig = this.getStepConfig(stepNumber);\n            if (this.isStepPotentiallyVisible(stepConfig)) {\n                result[stepNumber] = {stepId: stepConfig.stepid, position: position};\n                position++;\n            }\n        }\n\n        return result;\n    }\n\n    /**\n     * Is this step actually visible?\n     *\n     * @method  isStepActuallyVisible\n     * @param   {Object}    stepConfig      The step configuration to normalise\n     * @return  {Boolean}               Whether the step is actually visible\n     */\n    isStepActuallyVisible(stepConfig) {\n        if (!stepConfig) {\n            // Without step config, there can be no step.\n            return false;\n        }\n\n        // Check if the CSS styles are allowed on the browser or not.\n        if (!this.isCSSAllowed()) {\n            return false;\n        }\n\n        let target = this.getStepTarget(stepConfig);\n        if (target && target.length && target.is(':visible')) {\n            // Without a target, there can be no step.\n            return !!target.length;\n        }\n\n        return false;\n    }\n\n    /**\n     * Is the browser actually allow CSS styles?\n     *\n     * @returns {boolean} True if the browser is allowing CSS styles\n     */\n    isCSSAllowed() {\n        const testCSSElement = document.createElement('div');\n        testCSSElement.classList.add('hide');\n        document.body.appendChild(testCSSElement);\n        const styles = window.getComputedStyle(testCSSElement);\n        const isAllowed = styles.display === 'none';\n        testCSSElement.remove();\n\n        return isAllowed;\n    }\n\n    /**\n     * Go to the next step in the tour.\n     *\n     * @method  next\n     * @chainable\n     * @return {Object} this.\n     */\n    next() {\n        return this.gotoStep(this.getNextStepNumber());\n    }\n\n    /**\n     * Go to the previous step in the tour.\n     *\n     * @method  previous\n     * @chainable\n     * @return {Object} this.\n     */\n    previous() {\n        return this.gotoStep(this.getPreviousStepNumber(), -1);\n    }\n\n    /**\n     * Go to the specified step in the tour.\n     *\n     * @method  gotoStep\n     * @param   {Number}   stepNumber     The step number to display\n     * @param   {Number}   direction      Next or previous step\n     * @chainable\n     * @return {Object} this.\n     * @fires tool_usertours/stepRender\n     * @fires tool_usertours/stepRendered\n     * @fires tool_usertours/stepHide\n     * @fires tool_usertours/stepHidden\n     */\n    gotoStep(stepNumber, direction) {\n        if (stepNumber < 0) {\n            return this.endTour();\n        }\n\n        let stepConfig = this.getStepConfig(stepNumber);\n        if (stepConfig === null) {\n            return this.endTour();\n        }\n\n        return this._gotoStep(stepConfig, direction);\n    }\n\n    _gotoStep(stepConfig, direction) {\n        if (!stepConfig) {\n            return this.endTour();\n        }\n\n        if (typeof stepConfig.delay !== 'undefined' && stepConfig.delay && !stepConfig.delayed) {\n            stepConfig.delayed = true;\n            window.setTimeout(this._gotoStep.bind(this), stepConfig.delay, stepConfig, direction);\n\n            return this;\n        } else if (!stepConfig.orphan && !this.isStepActuallyVisible(stepConfig)) {\n            let fn = direction == -1 ? 'getPreviousStepNumber' : 'getNextStepNumber';\n            return this.gotoStep(this[fn](stepConfig.stepNumber), direction);\n        }\n\n        this.hide();\n\n        const stepRenderEvent = this.dispatchEvent(eventTypes.stepRender, {stepConfig}, true);\n        if (!stepRenderEvent.defaultPrevented) {\n            this.renderStep(stepConfig);\n            this.dispatchEvent(eventTypes.stepRendered, {stepConfig});\n        }\n\n        return this;\n    }\n\n    /**\n     * Fetch the normalised step configuration for the specified step number.\n     *\n     * @method  getStepConfig\n     * @param   {Number}   stepNumber      The step number to fetch configuration for\n     * @return  {Object}                    The step configuration\n     */\n    getStepConfig(stepNumber) {\n        if (stepNumber === null || stepNumber < 0 || stepNumber >= this.steps.length) {\n            return null;\n        }\n\n        // Normalise the step configuration.\n        let stepConfig = this.normalizeStepConfig(this.steps[stepNumber]);\n\n        // Add the stepNumber to the stepConfig.\n        stepConfig = $.extend(stepConfig, {stepNumber: stepNumber});\n\n        return stepConfig;\n    }\n\n    /**\n     * Normalise the supplied step configuration.\n     *\n     * @method  normalizeStepConfig\n     * @param   {Object}    stepConfig      The step configuration to normalise\n     * @return  {Object}                    The normalised step configuration\n     */\n    normalizeStepConfig(stepConfig) {\n\n        if (typeof stepConfig.reflex !== 'undefined' && typeof stepConfig.moveAfterClick === 'undefined') {\n            stepConfig.moveAfterClick = stepConfig.reflex;\n        }\n\n        if (typeof stepConfig.element !== 'undefined' && typeof stepConfig.target === 'undefined') {\n            stepConfig.target = stepConfig.element;\n        }\n\n        if (typeof stepConfig.content !== 'undefined' && typeof stepConfig.body === 'undefined') {\n            stepConfig.body = stepConfig.content;\n        }\n\n        stepConfig = $.extend({}, this.stepDefaults, stepConfig);\n\n        stepConfig = $.extend({}, {\n            attachTo: stepConfig.target,\n            attachPoint: 'after',\n        }, stepConfig);\n\n        if (stepConfig.attachTo) {\n            stepConfig.attachTo = $(stepConfig.attachTo).first();\n        }\n\n        return stepConfig;\n    }\n\n    /**\n     * Fetch the actual step target from the selector.\n     *\n     * This should not be called until after any delay has completed.\n     *\n     * @method  getStepTarget\n     * @param   {Object}    stepConfig      The step configuration\n     * @return  {$}\n     */\n    getStepTarget(stepConfig) {\n        if (stepConfig.target) {\n            return $(stepConfig.target);\n        }\n\n        return null;\n    }\n\n    /**\n     * Fire any event handlers for the specified event.\n     *\n     * @param {String} eventName The name of the event\n     * @param {Object} [detail={}] Any additional details to pass into the eveent\n     * @param {Boolean} [cancelable=false] Whether preventDefault() can be called\n     * @returns {CustomEvent}\n     */\n    dispatchEvent(\n        eventName,\n        detail = {},\n        cancelable = false\n    ) {\n        return dispatchEvent(eventName, {\n            // Add the tour to the detail.\n            tour: this,\n            ...detail,\n        }, document, {\n            cancelable,\n        });\n    }\n\n    /**\n     * @method addEventHandler\n     * @param  {string}      eventName       The name of the event to listen for\n     * @param  {function}    handler         The event handler to call\n     * @return {Object} this.\n     */\n    addEventHandler(eventName, handler) {\n        if (typeof this.eventHandlers[eventName] === 'undefined') {\n            this.eventHandlers[eventName] = [];\n        }\n\n        this.eventHandlers[eventName].push(handler);\n\n        return this;\n    }\n\n    /**\n     * Process listeners for the step being shown.\n     *\n     * @method  processStepListeners\n     * @param   {object}    stepConfig      The configuration for the step\n     * @chainable\n     * @return {Object} this.\n     */\n    processStepListeners(stepConfig) {\n        this.listeners.push(\n        // Next button.\n        {\n            node: this.currentStepNode,\n            args: ['click', '[data-role=\"next\"]', $.proxy(this.next, this)]\n        },\n\n        // Close and end tour buttons.\n        {\n            node: this.currentStepNode,\n            args: ['click', '[data-role=\"end\"]', $.proxy(this.endTour, this)]\n        },\n\n        // Click backdrop and hide tour.\n        {\n            node: $('[data-flexitour=\"backdrop\"]'),\n            args: ['click', $.proxy(this.hide, this)]\n        },\n\n        // Keypresses.\n        {\n            node: $('body'),\n            args: ['keydown', $.proxy(this.handleKeyDown, this)]\n        });\n\n        if (stepConfig.moveOnClick) {\n            var targetNode = this.getStepTarget(stepConfig);\n            this.listeners.push({\n                node: targetNode,\n                args: ['click', $.proxy(function(e) {\n                    if ($(e.target).parents('[data-flexitour=\"container\"]').length === 0) {\n                        // Ignore clicks when they are in the flexitour.\n                        window.setTimeout($.proxy(this.next, this), 500);\n                    }\n                }, this)]\n            });\n        }\n\n        this.listeners.forEach(function(listener) {\n            listener.node.on.apply(listener.node, listener.args);\n        });\n\n        return this;\n    }\n\n    /**\n     * Reset step listeners.\n     *\n     * @method  resetStepListeners\n     * @chainable\n     * @return {Object} this.\n     */\n    resetStepListeners() {\n        // Stop listening to all external handlers.\n        if (this.listeners) {\n            this.listeners.forEach(function(listener) {\n                listener.node.off.apply(listener.node, listener.args);\n            });\n        }\n        this.listeners = [];\n\n        return this;\n    }\n\n    /**\n     * The standard step renderer.\n     *\n     * @method  renderStep\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    renderStep(stepConfig) {\n        // Store the current step configuration for later.\n        this.currentStepConfig = stepConfig;\n        this.setCurrentStepNumber(stepConfig.stepNumber);\n\n        // Fetch the template and convert it to a $ object.\n        let template = $(this.getTemplateContent());\n\n        // Title.\n        template.find('[data-placeholder=\"title\"]')\n            .html(stepConfig.title);\n\n        // Body.\n        template.find('[data-placeholder=\"body\"]')\n            .html(stepConfig.body);\n\n        // Buttons.\n        const nextBtn = template.find('[data-role=\"next\"]');\n        const endBtn = template.find('[data-role=\"end\"]');\n\n        // Is this the final step?\n        if (this.isLastStep(stepConfig.stepNumber)) {\n            nextBtn.hide();\n            endBtn.removeClass(\"btn-secondary\").addClass(\"btn-primary\");\n        } else {\n            nextBtn.prop('disabled', false);\n            // Use Skip tour label for the End tour button.\n            getString('skip_tour', 'tool_usertours').then(value => {\n                endBtn.html(value);\n                return;\n            }).catch();\n        }\n\n        nextBtn.attr('role', 'button');\n        endBtn.attr('role', 'button');\n\n        if (this.originalConfiguration.displaystepnumbers) {\n            const stepsPotentiallyVisible = this.getPotentiallyVisibleSteps();\n            const totalStepsPotentiallyVisible = stepsPotentiallyVisible.length;\n            const position = stepsPotentiallyVisible[stepConfig.stepNumber].position;\n            if (totalStepsPotentiallyVisible > 1) {\n                // Change the label of the Next button to include the sequence.\n                getString('nextstep_sequence', 'tool_usertours',\n                    {position: position, total: totalStepsPotentiallyVisible}).then(value => {\n                    nextBtn.html(value);\n                    return;\n                }).catch();\n            }\n        }\n\n        // Replace the template with the updated version.\n        stepConfig.template = template;\n\n        // Add to the page.\n        this.addStepToPage(stepConfig);\n\n        // Process step listeners after adding to the page.\n        // This uses the currentNode.\n        this.processStepListeners(stepConfig);\n\n        return this;\n    }\n\n    /**\n     * Getter for the template content.\n     *\n     * @method  getTemplateContent\n     * @return  {$}\n     */\n    getTemplateContent() {\n        return $(this.templateContent).clone();\n    }\n\n    /**\n     * Helper to add a step to the page.\n     *\n     * @method  addStepToPage\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    addStepToPage(stepConfig) {\n        // Create the stepNode from the template data.\n        let currentStepNode = $('<span data-flexitour=\"container\"></span>')\n            .html(stepConfig.template)\n            .hide();\n\n        // The scroll animation occurs on the body or html.\n        let animationTarget = $('body, html')\n            .stop(true, true);\n\n        if (this.isStepActuallyVisible(stepConfig)) {\n            let targetNode = this.getStepTarget(stepConfig);\n\n            if (targetNode.parents('[data-usertour=\"scroller\"]').length) {\n                animationTarget = targetNode.parents('[data-usertour=\"scroller\"]');\n            }\n\n            targetNode.data('flexitour', 'target');\n\n            let zIndex = this.calculateZIndex(targetNode);\n            if (zIndex) {\n                stepConfig.zIndex = zIndex + 1;\n            }\n\n            if (stepConfig.zIndex) {\n                currentStepNode.css('zIndex', stepConfig.zIndex + 1);\n            }\n\n            // Add the backdrop.\n            this.positionBackdrop(stepConfig);\n\n            $(document.body).append(currentStepNode);\n            this.currentStepNode = currentStepNode;\n\n            // Ensure that the step node is positioned.\n            // Some situations mean that the value is not properly calculated without this step.\n            this.currentStepNode.css({\n                top: 0,\n                left: 0,\n            });\n\n            animationTarget\n                .animate({\n                    scrollTop: this.calculateScrollTop(stepConfig),\n                }).promise().then(function() {\n                        this.positionStep(stepConfig);\n                        this.revealStep(stepConfig);\n                        return;\n                    }.bind(this))\n                    .catch(function() {\n                        // Silently fail.\n                    });\n\n        } else if (stepConfig.orphan) {\n            stepConfig.isOrphan = true;\n\n            // This will be appended to the body instead.\n            stepConfig.attachTo = $('body').first();\n            stepConfig.attachPoint = 'append';\n\n            // Add the backdrop.\n            this.positionBackdrop(stepConfig);\n\n            // This is an orphaned step.\n            currentStepNode.addClass('orphan');\n\n            // It lives in the body.\n            $(document.body).append(currentStepNode);\n            this.currentStepNode = currentStepNode;\n\n            this.currentStepNode.css('position', 'fixed');\n\n            this.currentStepPopper = new Popper(\n                $('body'),\n                this.currentStepNode[0], {\n                    removeOnDestroy: true,\n                    placement: stepConfig.placement + '-start',\n                    arrowElement: '[data-role=\"arrow\"]',\n                    // Empty the modifiers. We've already placed the step and don't want it moved.\n                    modifiers: {\n                        hide: {\n                            enabled: false,\n                        },\n                        applyStyle: {\n                            onLoad: null,\n                            enabled: false,\n                        },\n                    },\n                    onCreate: () => {\n                        // First, we need to check if the step's content contains any images.\n                        const images = this.currentStepNode.find('img');\n                        if (images.length) {\n                            // Images found, need to calculate the position when the image is loaded.\n                            images.on('load', () => {\n                                this.calculateStepPositionInPage(currentStepNode);\n                            });\n                        }\n                        this.calculateStepPositionInPage(currentStepNode);\n                    }\n                }\n            );\n\n            this.revealStep(stepConfig);\n        }\n\n        return this;\n    }\n\n    /**\n     * Make the given step visible.\n     *\n     * @method revealStep\n     * @param {Object} stepConfig The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    revealStep(stepConfig) {\n        // Fade the step in.\n        this.currentStepNode.fadeIn('', $.proxy(function() {\n                // Announce via ARIA.\n                this.announceStep(stepConfig);\n\n                // Focus on the current step Node.\n                this.currentStepNode.focus();\n                window.setTimeout($.proxy(function() {\n                    // After a brief delay, focus again.\n                    // There seems to be an issue with Jaws where it only reads the dialogue title initially.\n                    // This second focus helps it to read the full dialogue.\n                    if (this.currentStepNode) {\n                        this.currentStepNode.focus();\n                    }\n                }, this), 100);\n\n            }, this));\n\n        return this;\n    }\n\n    /**\n     * Helper to announce the step on the page.\n     *\n     * @method  announceStep\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    announceStep(stepConfig) {\n        // Setup the step Dialogue as per:\n        // * https://www.w3.org/TR/wai-aria-practices/#dialog_nonmodal\n        // * https://www.w3.org/TR/wai-aria-practices/#dialog_modal\n\n        // Generate an ID for the current step node.\n        let stepId = 'tour-step-' + this.tourName + '-' + stepConfig.stepNumber;\n        this.currentStepNode.attr('id', stepId);\n\n        let bodyRegion = this.currentStepNode.find('[data-placeholder=\"body\"]').first();\n        bodyRegion.attr('id', stepId + '-body');\n        bodyRegion.attr('role', 'document');\n\n        let headerRegion = this.currentStepNode.find('[data-placeholder=\"title\"]').first();\n        headerRegion.attr('id', stepId + '-title');\n        headerRegion.attr('aria-labelledby', stepId + '-body');\n\n        // Generally, a modal dialog has a role of dialog.\n        this.currentStepNode.attr('role', 'dialog');\n        this.currentStepNode.attr('tabindex', 0);\n        this.currentStepNode.attr('aria-labelledby', stepId + '-title');\n        this.currentStepNode.attr('aria-describedby', stepId + '-body');\n\n        // Configure ARIA attributes on the target.\n        let target = this.getStepTarget(stepConfig);\n        if (target) {\n            target.data('original-tabindex', target.attr('tabindex'));\n            if (!target.attr('tabindex')) {\n                target.attr('tabindex', 0);\n            }\n\n            target\n                .data('original-describedby', target.attr('aria-describedby'))\n                .attr('aria-describedby', stepId + '-body')\n                ;\n        }\n\n        this.accessibilityShow(stepConfig);\n\n        return this;\n    }\n\n    /**\n     * Handle key down events.\n     *\n     * @method  handleKeyDown\n     * @param   {EventFacade} e\n     */\n    handleKeyDown(e) {\n        let tabbableSelector = 'a[href], link[href], [draggable=true], [contenteditable=true], ';\n        tabbableSelector += ':input:enabled, [tabindex], button:enabled';\n        switch (e.keyCode) {\n            case 27:\n                this.endTour();\n                break;\n\n            // 9 == Tab - trap focus for items with a backdrop.\n            case 9:\n                // Tab must be handled on key up only in this instance.\n                (function() {\n                    if (!this.currentStepConfig.hasBackdrop) {\n                        // Trapping tab focus is only handled for those steps with a backdrop.\n                        return;\n                    }\n\n                    // Find all tabbable locations.\n                    let activeElement = $(document.activeElement);\n                    let stepTarget = this.getStepTarget(this.currentStepConfig);\n                    let tabbableNodes = $(tabbableSelector);\n                    let dialogContainer = $('span[data-flexitour=\"container\"]');\n                    let currentIndex;\n                    // Filter out element which is not belong to target section or dialogue.\n                    if (stepTarget) {\n                        tabbableNodes = tabbableNodes.filter(function(index, element) {\n                            return stepTarget !== null\n                                && (stepTarget.has(element).length\n                                    || dialogContainer.has(element).length\n                                    || stepTarget.is(element)\n                                    || dialogContainer.is(element));\n                        });\n                    }\n\n                    // Find index of focusing element.\n                    tabbableNodes.each(function(index, element) {\n                        if (activeElement.is(element)) {\n                            currentIndex = index;\n                            return false;\n                        }\n                        // Keep looping.\n                        return true;\n                    });\n\n                    let nextIndex;\n                    let nextNode;\n                    let focusRelevant;\n                    if (currentIndex != void 0) {\n                        let direction = 1;\n                        if (e.shiftKey) {\n                            direction = -1;\n                        }\n                        nextIndex = currentIndex;\n                        do {\n                            nextIndex += direction;\n                            nextNode = $(tabbableNodes[nextIndex]);\n                        } while (nextNode.length && nextNode.is(':disabled') || nextNode.is(':hidden'));\n                        if (nextNode.length) {\n                            // A new f\n                            focusRelevant = nextNode.closest(stepTarget).length;\n                            focusRelevant = focusRelevant || nextNode.closest(this.currentStepNode).length;\n                        } else {\n                            // Unable to find the target somehow.\n                            focusRelevant = false;\n                        }\n                    }\n\n                    if (focusRelevant) {\n                        nextNode.focus();\n                    } else {\n                        if (e.shiftKey) {\n                            // Focus on the last tabbable node in the step.\n                            this.currentStepNode.find(tabbableSelector).last().focus();\n                        } else {\n                            if (this.currentStepConfig.isOrphan) {\n                                // Focus on the step - there is no target.\n                                this.currentStepNode.focus();\n                            } else {\n                                // Focus on the step target.\n                                stepTarget.focus();\n                            }\n                        }\n                    }\n                    e.preventDefault();\n                }).call(this);\n                break;\n        }\n    }\n\n    /**\n     * Start the current tour.\n     *\n     * @method  startTour\n     * @param   {Number} startAt Which step number to start at. If not specified, starts at the last point.\n     * @chainable\n     * @return {Object} this.\n     * @fires tool_usertours/tourStart\n     * @fires tool_usertours/tourStarted\n     */\n    startTour(startAt) {\n        if (this.storage && typeof startAt === 'undefined') {\n            let storageStartValue = this.storage.getItem(this.storageKey);\n            if (storageStartValue) {\n                let storageStartAt = parseInt(storageStartValue, 10);\n                if (storageStartAt <= this.steps.length) {\n                    startAt = storageStartAt;\n                }\n            }\n        }\n\n        if (typeof startAt === 'undefined') {\n            startAt = this.getCurrentStepNumber();\n        }\n\n        const tourStartEvent = this.dispatchEvent(eventTypes.tourStart, {startAt}, true);\n        if (!tourStartEvent.defaultPrevented) {\n            this.gotoStep(startAt);\n            this.tourRunning = true;\n            this.dispatchEvent(eventTypes.tourStarted, {startAt});\n        }\n\n        return this;\n    }\n\n    /**\n     * Restart the tour from the beginning, resetting the completionlag.\n     *\n     * @method  restartTour\n     * @chainable\n     * @return {Object} this.\n     */\n    restartTour() {\n        return this.startTour(0);\n    }\n\n    /**\n     * End the current tour.\n     *\n     * @method  endTour\n     * @chainable\n     * @return {Object} this.\n     * @fires tool_usertours/tourEnd\n     * @fires tool_usertours/tourEnded\n     */\n    endTour() {\n        const tourEndEvent = this.dispatchEvent(eventTypes.tourEnd, {}, true);\n        if (tourEndEvent.defaultPrevented) {\n            return this;\n        }\n\n        if (this.currentStepConfig) {\n            let previousTarget = this.getStepTarget(this.currentStepConfig);\n            if (previousTarget) {\n                if (!previousTarget.attr('tabindex')) {\n                    previousTarget.attr('tabindex', '-1');\n                }\n                previousTarget.focus();\n            }\n        }\n\n        this.hide(true);\n\n        this.tourRunning = false;\n        this.dispatchEvent(eventTypes.tourEnded);\n\n        return this;\n    }\n\n    /**\n     * Hide any currently visible steps.\n     *\n     * @method hide\n     * @param {Bool} transition Animate the visibility change\n     * @chainable\n     * @return {Object} this.\n     * @fires tool_usertours/stepHide\n     * @fires tool_usertours/stepHidden\n     */\n    hide(transition) {\n        const stepHideEvent = this.dispatchEvent(eventTypes.stepHide, {}, true);\n        if (stepHideEvent.defaultPrevented) {\n            return this;\n        }\n\n        if (this.currentStepNode && this.currentStepNode.length) {\n            this.currentStepNode.hide();\n            if (this.currentStepPopper) {\n                this.currentStepPopper.destroy();\n            }\n        }\n\n        // Restore original target configuration.\n        if (this.currentStepConfig) {\n            let target = this.getStepTarget(this.currentStepConfig);\n            if (target) {\n                if (target.data('original-labelledby')) {\n                    target.attr('aria-labelledby', target.data('original-labelledby'));\n                }\n\n                if (target.data('original-describedby')) {\n                    target.attr('aria-describedby', target.data('original-describedby'));\n                }\n\n                if (target.data('original-tabindex')) {\n                    target.attr('tabindex', target.data('tabindex'));\n                } else {\n                    // If the target does not have the tabindex attribute at the beginning. We need to remove it.\n                    // We should wait a little here before removing the attribute to prevent the browser from adding it again.\n                    window.setTimeout(() => {\n                        target.removeAttr('tabindex');\n                    }, 400);\n                }\n            }\n\n            // Clear the step configuration.\n            this.currentStepConfig = null;\n        }\n\n        let fadeTime = 0;\n        if (transition) {\n            fadeTime = 400;\n        }\n\n        // Remove the backdrop features.\n        $('[data-flexitour=\"step-background\"]').remove();\n        $('[data-flexitour=\"step-backdrop\"]').removeAttr('data-flexitour');\n        $('[data-flexitour=\"backdrop\"]').fadeOut(fadeTime, function() {\n            $(this).remove();\n        });\n\n        // Remove aria-describedby and tabindex attributes.\n        if (this.currentStepNode && this.currentStepNode.length) {\n            let stepId = this.currentStepNode.attr('id');\n            if (stepId) {\n                let currentStepElement = '[aria-describedby=\"' + stepId + '-body\"]';\n                $(currentStepElement).removeAttr('tabindex');\n                $(currentStepElement).removeAttr('aria-describedby');\n            }\n        }\n\n        // Reset the listeners.\n        this.resetStepListeners();\n\n        this.accessibilityHide();\n\n        this.dispatchEvent(eventTypes.stepHidden);\n\n        this.currentStepNode = null;\n        this.currentStepPopper = null;\n        return this;\n    }\n\n    /**\n     * Show the current steps.\n     *\n     * @method show\n     * @chainable\n     * @return {Object} this.\n     */\n    show() {\n        // Show the current step.\n        let startAt = this.getCurrentStepNumber();\n\n        return this.gotoStep(startAt);\n    }\n\n    /**\n     * Return the current step node.\n     *\n     * @method  getStepContainer\n     * @return  {jQuery}\n     */\n    getStepContainer() {\n        return $(this.currentStepNode);\n    }\n\n    /**\n     * Calculate scrollTop.\n     *\n     * @method  calculateScrollTop\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @return  {Number}\n     */\n    calculateScrollTop(stepConfig) {\n        let viewportHeight = $(window).height();\n        let targetNode = this.getStepTarget(stepConfig);\n\n        let scrollParent = $(window);\n        if (targetNode.parents('[data-usertour=\"scroller\"]').length) {\n            scrollParent = targetNode.parents('[data-usertour=\"scroller\"]');\n        }\n        let scrollTop = scrollParent.scrollTop();\n\n        if (stepConfig.placement === 'top') {\n            // If the placement is top, center scroll at the top of the target.\n            scrollTop = targetNode.offset().top - (viewportHeight / 2);\n        } else if (stepConfig.placement === 'bottom') {\n            // If the placement is bottom, center scroll at the bottom of the target.\n            scrollTop = targetNode.offset().top + targetNode.height() + scrollTop - (viewportHeight / 2);\n        } else if (targetNode.height() <= (viewportHeight * 0.8)) {\n            // If the placement is left/right, and the target fits in the viewport, centre screen on the target\n            scrollTop = targetNode.offset().top - ((viewportHeight - targetNode.height()) / 2);\n        } else {\n            // If the placement is left/right, and the target is bigger than the viewport, set scrollTop to target.top + buffer\n            // and change step attachmentTarget to top+.\n            scrollTop = targetNode.offset().top - (viewportHeight * 0.2);\n        }\n\n        // Never scroll over the top.\n        scrollTop = Math.max(0, scrollTop);\n\n        // Never scroll beyond the bottom.\n        scrollTop = Math.min($(document).height() - viewportHeight, scrollTop);\n\n        return Math.ceil(scrollTop);\n    }\n\n    /**\n     * Calculate dialogue position for page middle.\n     *\n     * @param {jQuery} currentStepNode Current step node\n     * @method  calculateScrollTop\n     */\n    calculateStepPositionInPage(currentStepNode) {\n        let top = MINSPACING;\n        const viewportHeight = $(window).height();\n        const stepHeight = currentStepNode.height();\n        const viewportWidth = $(window).width();\n        const stepWidth = currentStepNode.width();\n        if (viewportHeight >= (stepHeight + (MINSPACING * 2))) {\n            top = Math.ceil((viewportHeight - stepHeight) / 2);\n        } else {\n            const headerHeight = currentStepNode.find('.modal-header').first().outerHeight() ?? 0;\n            const footerHeight = currentStepNode.find('.modal-footer').first().outerHeight() ?? 0;\n            const currentStepBody = currentStepNode.find('[data-placeholder=\"body\"]').first();\n            const maxHeight = viewportHeight - (MINSPACING * 2) - headerHeight - footerHeight;\n            currentStepBody.css({\n                'max-height': maxHeight + 'px',\n                'overflow': 'auto',\n            });\n        }\n        currentStepNode.offset({\n            top: top,\n            left: Math.ceil((viewportWidth - stepWidth) / 2)\n        });\n    }\n\n    /**\n     * Position the step on the page.\n     *\n     * @method  positionStep\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    positionStep(stepConfig) {\n        let content = this.currentStepNode;\n        let thisT = this;\n        if (!content || !content.length) {\n            // Unable to find the step node.\n            return this;\n        }\n\n        stepConfig.placement = this.recalculatePlacement(stepConfig);\n        let flipBehavior;\n        switch (stepConfig.placement) {\n            case 'left':\n                flipBehavior = ['left', 'right', 'top', 'bottom'];\n                break;\n            case 'right':\n                flipBehavior = ['right', 'left', 'top', 'bottom'];\n                break;\n            case 'top':\n                flipBehavior = ['top', 'bottom', 'right', 'left'];\n                break;\n            case 'bottom':\n                flipBehavior = ['bottom', 'top', 'right', 'left'];\n                break;\n            default:\n                flipBehavior = 'flip';\n                break;\n        }\n\n        let target = this.getStepTarget(stepConfig);\n        var config = {\n            placement: stepConfig.placement + '-start',\n            removeOnDestroy: true,\n            modifiers: {\n                flip: {\n                    behaviour: flipBehavior,\n                },\n                arrow: {\n                    element: '[data-role=\"arrow\"]',\n                },\n            },\n            onCreate: function(data) {\n                recalculateArrowPosition(data);\n                recalculateStepPosition(data);\n            },\n            onUpdate: function(data) {\n                recalculateArrowPosition(data);\n                if (thisT.possitionNeedToBeRecalculated) {\n                    thisT.recalculatedNo++;\n                    thisT.possitionNeedToBeRecalculated = false;\n                    recalculateStepPosition(data);\n                }\n            },\n        };\n\n        let recalculateArrowPosition = function(data) {\n            let placement = data.placement.split('-')[0];\n            const isVertical = ['left', 'right'].indexOf(placement) !== -1;\n            const arrowElement = data.instance.popper.querySelector('[data-role=\"arrow\"]');\n            const stepElement = $(data.instance.popper.querySelector('[data-role=\"flexitour-step\"]'));\n            if (isVertical) {\n                let arrowHeight = parseFloat(window.getComputedStyle(arrowElement).height);\n                let arrowOffset = parseFloat(window.getComputedStyle(arrowElement).top);\n                let popperHeight = parseFloat(window.getComputedStyle(data.instance.popper).height);\n                let popperOffset = parseFloat(window.getComputedStyle(data.instance.popper).top);\n                let popperBorderWidth = parseFloat(stepElement.css('borderTopWidth'));\n                let popperBorderRadiusWidth = parseFloat(stepElement.css('borderTopLeftRadius')) * 2;\n                let arrowPos = arrowOffset + (arrowHeight / 2);\n                let maxPos = popperHeight + popperOffset - popperBorderWidth - popperBorderRadiusWidth;\n                let minPos = popperOffset + popperBorderWidth + popperBorderRadiusWidth;\n                if (arrowPos >= maxPos || arrowPos <= minPos) {\n                    let newArrowPos = 0;\n                    if (arrowPos > (popperHeight / 2)) {\n                        newArrowPos = maxPos - arrowHeight;\n                    } else {\n                        newArrowPos = minPos + arrowHeight;\n                    }\n                    $(arrowElement).css('top', newArrowPos);\n                }\n            } else {\n                let arrowWidth = parseFloat(window.getComputedStyle(arrowElement).width);\n                let arrowOffset = parseFloat(window.getComputedStyle(arrowElement).left);\n                let popperWidth = parseFloat(window.getComputedStyle(data.instance.popper).width);\n                let popperOffset = parseFloat(window.getComputedStyle(data.instance.popper).left);\n                let popperBorderWidth = parseFloat(stepElement.css('borderTopWidth'));\n                let popperBorderRadiusWidth = parseFloat(stepElement.css('borderTopLeftRadius')) * 2;\n                let arrowPos = arrowOffset + (arrowWidth / 2);\n                let maxPos = popperWidth + popperOffset - popperBorderWidth - popperBorderRadiusWidth;\n                let minPos = popperOffset + popperBorderWidth + popperBorderRadiusWidth;\n                if (arrowPos >= maxPos || arrowPos <= minPos) {\n                    let newArrowPos = 0;\n                    if (arrowPos > (popperWidth / 2)) {\n                        newArrowPos = maxPos - arrowWidth;\n                    } else {\n                        newArrowPos = minPos + arrowWidth;\n                    }\n                    $(arrowElement).css('left', newArrowPos);\n                }\n            }\n        };\n\n        const recalculateStepPosition = function(data) {\n            const placement = data.placement.split('-')[0];\n            const isVertical = ['left', 'right'].indexOf(placement) !== -1;\n            const popperElement = $(data.instance.popper);\n            const targetElement = $(data.instance.reference);\n            const arrowElement = popperElement.find('[data-role=\"arrow\"]');\n            const stepElement = popperElement.find('[data-role=\"flexitour-step\"]');\n            const viewportHeight = $(window).height();\n            const viewportWidth = $(window).width();\n            const arrowHeight = parseFloat(arrowElement.outerHeight(true));\n            const popperHeight = parseFloat(popperElement.outerHeight(true));\n            const targetHeight = parseFloat(targetElement.outerHeight(true));\n            const arrowWidth = parseFloat(arrowElement.outerWidth(true));\n            const popperWidth = parseFloat(popperElement.outerWidth(true));\n            const targetWidth = parseFloat(targetElement.outerWidth(true));\n            let maxHeight;\n\n            if (thisT.recalculatedNo > 1) {\n                // The current screen is too small, and cannot fit with the original placement.\n                // We should set the placement to auto so the PopperJS can calculate the perfect placement.\n                thisT.currentStepPopper.options.placement = isVertical ? 'auto-left' : 'auto-bottom';\n            }\n            if (thisT.recalculatedNo > 2) {\n                // Return here to prevent recursive calling.\n                return;\n            }\n\n            if (isVertical) {\n                // Find the best place to put the tour: Left of right.\n                const leftSpace = targetElement.offset().left > 0 ? targetElement.offset().left : 0;\n                const rightSpace = viewportWidth - leftSpace - targetWidth;\n                const remainingSpace = leftSpace >= rightSpace ? leftSpace : rightSpace;\n                maxHeight = viewportHeight - MINSPACING * 2;\n                if (remainingSpace < (popperWidth + arrowWidth)) {\n                    const maxWidth = remainingSpace - MINSPACING - arrowWidth;\n                    if (maxWidth > 0) {\n                        popperElement.css({\n                            'max-width': maxWidth + 'px',\n                        });\n                        // Not enough space, flag true to make Popper to recalculate the position.\n                        thisT.possitionNeedToBeRecalculated = true;\n                    }\n                } else if (maxHeight < popperHeight) {\n                    // Check if the Popper's height can fit the viewport height or not.\n                    // If not, set the correct max-height value for the Popper element.\n                    popperElement.css({\n                        'max-height': maxHeight + 'px',\n                    });\n                }\n            } else {\n                // Find the best place to put the tour: Top of bottom.\n                const topSpace = targetElement.offset().top > 0 ? targetElement.offset().top : 0;\n                const bottomSpace = viewportHeight - topSpace - targetHeight;\n                const remainingSpace = topSpace >= bottomSpace ? topSpace : bottomSpace;\n                maxHeight = remainingSpace - MINSPACING - arrowHeight;\n                if (remainingSpace < (popperHeight + arrowHeight)) {\n                    // Not enough space, flag true to make Popper to recalculate the position.\n                    thisT.possitionNeedToBeRecalculated = true;\n                }\n            }\n\n            // Check if the Popper's height can fit the viewport height or not.\n            // If not, set the correct max-height value for the body.\n            const currentStepBody = stepElement.find('[data-placeholder=\"body\"]').first();\n            const headerEle = stepElement.find('.modal-header').first();\n            const footerEle = stepElement.find('.modal-footer').first();\n            const headerHeight = headerEle.outerHeight(true) ?? 0;\n            const footerHeight = footerEle.outerHeight(true) ?? 0;\n            maxHeight = maxHeight - headerHeight - footerHeight;\n            if (maxHeight > 0) {\n                headerEle.removeClass('minimal');\n                footerEle.removeClass('minimal');\n                currentStepBody.css({\n                    'max-height': maxHeight + 'px',\n                    'overflow': 'auto',\n                });\n            } else {\n                headerEle.addClass('minimal');\n                footerEle.addClass('minimal');\n            }\n            // Call the Popper update method to update the position.\n            thisT.currentStepPopper.update();\n        };\n\n        let background = $('[data-flexitour=\"step-background\"]');\n        if (background.length) {\n            target = background;\n        }\n        this.currentStepPopper = new Popper(target, content[0], config);\n\n        return this;\n    }\n\n    /**\n     * For left/right placement, checks that there is room for the step at current window size.\n     *\n     * If there is not enough room, changes placement to 'top'.\n     *\n     * @method  recalculatePlacement\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @return  {String}                    The placement after recalculate\n     */\n    recalculatePlacement(stepConfig) {\n        const buffer = 10;\n        const arrowWidth = 16;\n        let target = this.getStepTarget(stepConfig);\n        let widthContent = this.currentStepNode.width() + arrowWidth;\n        let targetOffsetLeft = target.offset().left - buffer;\n        let targetOffsetRight = target.offset().left + target.width() + buffer;\n        let placement = stepConfig.placement;\n\n        if (['left', 'right'].indexOf(placement) !== -1) {\n            if ((targetOffsetLeft < (widthContent + buffer)) &&\n                ((targetOffsetRight + widthContent + buffer) > document.documentElement.clientWidth)) {\n                placement = 'top';\n            }\n        }\n        return placement;\n    }\n\n    /**\n     * Add the backdrop.\n     *\n     * @method  positionBackdrop\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    positionBackdrop(stepConfig) {\n        if (stepConfig.backdrop) {\n            this.currentStepConfig.hasBackdrop = true;\n            let backdrop = $('<div data-flexitour=\"backdrop\"></div>');\n\n            if (stepConfig.zIndex) {\n                if (stepConfig.attachPoint === 'append') {\n                    stepConfig.attachTo.append(backdrop);\n                } else {\n                    backdrop.insertAfter(stepConfig.attachTo);\n                }\n            } else {\n                $('body').append(backdrop);\n            }\n\n            if (this.isStepActuallyVisible(stepConfig)) {\n                // The step has a visible target.\n                // Punch a hole through the backdrop.\n                let background = $('[data-flexitour=\"step-background\"]');\n                if (!background.length) {\n                    background = $('<div data-flexitour=\"step-background\"></div>');\n                }\n\n                let targetNode = this.getStepTarget(stepConfig);\n\n                let buffer = 10;\n\n                let colorNode = targetNode;\n                if (buffer) {\n                    colorNode = $('body');\n                }\n\n                let drawertop = 0;\n                if (targetNode.parents('[data-usertour=\"scroller\"]').length) {\n                    const scrollerElement = targetNode.parents('[data-usertour=\"scroller\"]');\n                    const navigationBuffer = scrollerElement.offset().top;\n                    if (scrollerElement.scrollTop() >= navigationBuffer) {\n                        drawertop = scrollerElement.scrollTop() - navigationBuffer;\n                        background.css({\n                            position: 'fixed'\n                        });\n                    }\n                }\n\n                background.css({\n                    width: targetNode.outerWidth() + buffer + buffer,\n                    height: targetNode.outerHeight() + buffer + buffer,\n                    left: targetNode.offset().left - buffer,\n                    top: targetNode.offset().top + drawertop - buffer,\n                    backgroundColor: this.calculateInherittedBackgroundColor(colorNode),\n                });\n\n                if (targetNode.offset().left < buffer) {\n                    background.css({\n                        width: targetNode.outerWidth() + targetNode.offset().left + buffer,\n                        left: targetNode.offset().left,\n                    });\n                }\n\n                if ((targetNode.offset().top + drawertop) < buffer) {\n                    background.css({\n                        height: targetNode.outerHeight() + targetNode.offset().top + buffer,\n                        top: targetNode.offset().top,\n                    });\n                }\n\n                let targetRadius = targetNode.css('borderRadius');\n                if (targetRadius && targetRadius !== $('body').css('borderRadius')) {\n                    background.css('borderRadius', targetRadius);\n                }\n\n                let targetPosition = this.calculatePosition(targetNode);\n                if (targetPosition === 'absolute') {\n                    background.css('position', 'fixed');\n                }\n\n                let fader = background.clone();\n                fader.css({\n                    backgroundColor: backdrop.css('backgroundColor'),\n                    opacity: backdrop.css('opacity'),\n                });\n                fader.attr('data-flexitour', 'step-background-fader');\n\n                if (targetNode.parents('[data-region=\"fixed-drawer\"]').length) {\n                    let targetClone = targetNode.clone();\n                    background.append(targetClone);\n                }\n\n                if (stepConfig.zIndex) {\n                    if (stepConfig.attachPoint === 'append') {\n                        stepConfig.attachTo.append(background);\n                    } else {\n                        fader.insertAfter(stepConfig.attachTo);\n                        background.insertAfter(stepConfig.attachTo);\n                    }\n                } else {\n                    $('body').append(fader);\n                    $('body').append(background);\n                }\n\n                // Add the backdrop data to the actual target.\n                // This is the part which actually does the work.\n                targetNode.attr('data-flexitour', 'step-backdrop');\n\n                if (stepConfig.zIndex) {\n                    backdrop.css('zIndex', stepConfig.zIndex);\n                    background.css('zIndex', stepConfig.zIndex + 1);\n                    targetNode.css('zIndex', stepConfig.zIndex + 2);\n                }\n\n                fader.fadeOut('2000', function() {\n                    $(this).remove();\n                });\n            }\n        }\n        return this;\n    }\n\n    /**\n     * Calculate the inheritted z-index.\n     *\n     * @method  calculateZIndex\n     * @param   {jQuery}    elem                        The element to calculate z-index for\n     * @return  {Number}                                Calculated z-index\n     */\n    calculateZIndex(elem) {\n        elem = $(elem);\n        while (elem.length && elem[0] !== document) {\n            // Ignore z-index if position is set to a value where z-index is ignored by the browser\n            // This makes behavior of this function consistent across browsers\n            // WebKit always returns auto if the element is positioned.\n            let position = elem.css(\"position\");\n            if (position === \"absolute\" || position === \"relative\" || position === \"fixed\") {\n                // IE returns 0 when zIndex is not specified\n                // other browsers return a string\n                // we ignore the case of nested elements with an explicit value of 0\n                // <div style=\"z-index: -10;\"><div style=\"z-index: 0;\"></div></div>\n                let value = parseInt(elem.css(\"zIndex\"), 10);\n                if (!isNaN(value) && value !== 0) {\n                    return value;\n                }\n            }\n            elem = elem.parent();\n        }\n\n        return 0;\n    }\n\n    /**\n     * Calculate the inheritted background colour.\n     *\n     * @method  calculateInherittedBackgroundColor\n     * @param   {jQuery}    elem                        The element to calculate colour for\n     * @return  {String}                                Calculated background colour\n     */\n    calculateInherittedBackgroundColor(elem) {\n        // Use a fake node to compare each element against.\n        let fakeNode = $('<div>').hide();\n        $('body').append(fakeNode);\n        let fakeElemColor = fakeNode.css('backgroundColor');\n        fakeNode.remove();\n\n        elem = $(elem);\n        while (elem.length && elem[0] !== document) {\n            let color = elem.css('backgroundColor');\n            if (color !== fakeElemColor) {\n                return color;\n            }\n            elem = elem.parent();\n        }\n\n        return null;\n    }\n\n    /**\n     * Calculate the inheritted position.\n     *\n     * @method  calculatePosition\n     * @param   {jQuery}    elem                        The element to calculate position for\n     * @return  {String}                                Calculated position\n     */\n    calculatePosition(elem) {\n        elem = $(elem);\n        while (elem.length && elem[0] !== document) {\n            let position = elem.css('position');\n            if (position !== 'static') {\n                return position;\n            }\n            elem = elem.parent();\n        }\n\n        return null;\n    }\n\n    /**\n     * Perform accessibility changes for step shown.\n     *\n     * This will add aria-hidden=\"true\" to all siblings and parent siblings.\n     *\n     * @method  accessibilityShow\n     */\n    accessibilityShow() {\n        let stateHolder = 'data-has-hidden';\n        let attrName = 'aria-hidden';\n        let hideFunction = function(child) {\n            let flexitourRole = child.data('flexitour');\n            if (flexitourRole) {\n                switch (flexitourRole) {\n                    case 'container':\n                    case 'target':\n                        return;\n                }\n            }\n\n            let hidden = child.attr(attrName);\n            if (!hidden) {\n                child.attr(stateHolder, true);\n                Aria.hide(child);\n            }\n        };\n\n        this.currentStepNode.siblings().each(function(index, node) {\n            hideFunction($(node));\n        });\n        this.currentStepNode.parentsUntil('body').siblings().each(function(index, node) {\n            hideFunction($(node));\n        });\n    }\n\n    /**\n     * Perform accessibility changes for step hidden.\n     *\n     * This will remove any newly added aria-hidden=\"true\".\n     *\n     * @method  accessibilityHide\n     */\n    accessibilityHide() {\n        let stateHolder = 'data-has-hidden';\n        let showFunction = function(child) {\n            let hidden = child.attr(stateHolder);\n            if (typeof hidden !== 'undefined') {\n                child.removeAttr(stateHolder);\n                Aria.unhide(child);\n            }\n        };\n\n        $('[' + stateHolder + ']').each(function(index, node) {\n            showFunction($(node));\n        });\n    }\n};\n\nexport default Tour;\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireDefault","obj","__esModule","default","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","_typeof","Symbol","iterator","constructor","prototype","_defineProperties","props","descriptor","configurable","writable","_toPropertyKey","value","arg","input","hint","prim","toPrimitive","undefined","res","call","TypeError","String","Number","_toPrimitive","_jquery","Aria","cache","has","get","newObj","hasPropertyDescriptor","hasOwnProperty","desc","set","_interopRequireWildcard","_popper","Tour","config","instance","Constructor","_classCallCheck","this","init","protoProps","staticProps","eventHandlers","reset","originalConfiguration","configure","possitionNeedToBeRecalculated","recalculatedNo","storage","window","sessionStorage","storageKey","tourName","e","prefetchStrings","hide","resetStepListeners","steps","currentStepNumber","_this","_loop","eventName","handler","addEventHandler","resetStepDefaults","template","templateContent","checkMinimumRequirements","Error","loadOriginalConfiguration","stepDefaults","setStepDefaults","$","extend","element","placement","delay","moveOnClick","moveAfterTime","orphan","direction","parseInt","stepNumber","setItem","code","DOMException","QUOTA_EXCEEDED_ERR","removeItem","getCurrentStepNumber","nextStepNumber","isStepPotentiallyVisible","getStepConfig","previousStepNumber","getNextStepNumber","stepConfig","isStepActuallyVisible","position","result","stepId","stepid","isCSSAllowed","getStepTarget","is","testCSSElement","document","createElement","classList","add","body","appendChild","isAllowed","getComputedStyle","display","remove","gotoStep","getPreviousStepNumber","endTour","_gotoStep","delayed","setTimeout","bind","fn","dispatchEvent","eventTypes","stepRender","defaultPrevented","renderStep","stepRendered","normalizeStepConfig","reflex","moveAfterClick","content","attachTo","attachPoint","first","detail","cancelable","tour","listeners","node","currentStepNode","args","proxy","next","handleKeyDown","targetNode","parents","listener","on","off","currentStepConfig","setCurrentStepNumber","getTemplateContent","find","html","title","nextBtn","endBtn","isLastStep","removeClass","addClass","prop","getString","then","catch","attr","displaystepnumbers","stepsPotentiallyVisible","getPotentiallyVisibleSteps","totalStepsPotentiallyVisible","get_string","total","addStepToPage","processStepListeners","clone","_this2","animationTarget","stop","data","zIndex","calculateZIndex","css","positionBackdrop","append","top","left","animate","scrollTop","calculateScrollTop","promise","positionStep","revealStep","isOrphan","currentStepPopper","Popper","removeOnDestroy","arrowElement","modifiers","enabled","applyStyle","onLoad","onCreate","images","calculateStepPositionInPage","fadeIn","announceStep","focus","bodyRegion","headerRegion","accessibilityShow","tabbableSelector","keyCode","hasBackdrop","currentIndex","nextIndex","nextNode","focusRelevant","activeElement","stepTarget","tabbableNodes","dialogContainer","index","each","shiftKey","closest","last","preventDefault","startAt","storageStartValue","getItem","storageStartAt","tourStart","tourRunning","tourStarted","startTour","tourEnd","previousTarget","tourEnded","transition","stepHide","destroy","removeAttr","fadeTime","fadeOut","currentStepElement","accessibilityHide","stepHidden","viewportHeight","height","scrollParent","offset","Math","max","min","ceil","stepHeight","viewportWidth","width","stepWidth","MINSPACING","_currentStepNode$find","_currentStepNode$find2","maxHeight","outerHeight","overflow","flipBehavior","thisT","recalculatePlacement","flip","behaviour","arrow","recalculateArrowPosition","recalculateStepPosition","onUpdate","split","isVertical","indexOf","popper","querySelector","stepElement","arrowHeight","parseFloat","arrowOffset","popperHeight","popperOffset","popperBorderWidth","popperBorderRadiusWidth","arrowPos","maxPos","minPos","newArrowPos","arrowWidth","popperWidth","_headerEle$outerHeigh","_footerEle$outerHeigh","popperElement","targetElement","reference","targetHeight","outerWidth","targetWidth","options","leftSpace","rightSpace","remainingSpace","maxWidth","topSpace","bottomSpace","currentStepBody","headerEle","footerEle","update","background","widthContent","targetOffsetLeft","targetOffsetRight","documentElement","clientWidth","backdrop","insertAfter","colorNode","drawertop","scrollerElement","navigationBuffer","backgroundColor","calculateInherittedBackgroundColor","targetRadius","calculatePosition","fader","opacity","targetClone","elem","isNaN","parent","fakeNode","fakeElemColor","color","hideFunction","child","flexitourRole","siblings","parentsUntil","unhide","_default","_exports"],"mappings":"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"}